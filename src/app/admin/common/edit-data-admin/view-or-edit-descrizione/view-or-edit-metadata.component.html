<!-- ===============================
     CONTENITORE PRINCIPALE DEL POPUP
=============================== -->
<div class="popup-container">

  <!-- ===============================
       PULSANTE DI CHIUSURA (ANG. DESTRO)
  ================================ -->
  <button class="chiudi-btn" (click)="chiudiDialog()" matTooltip="chiudi" aria-label="Chiudi popup">
    <mat-icon>close</mat-icon>
  </button>

  <!-- ===============================
       CONTENITORE SCROLLABILE INTERNO
       Tutto il contenuto scorre qui
  ================================ -->
  <div class="scroll-container">

    <!-- ===============================
         MODALITÀ MODIFICA
    ================================ -->
    <ng-container *ngIf="!onlyViewInput; else soloVisualizzazione">

      <!-- Titolo -->
      <h2>Modifica dei metadati</h2>

      <!-- Ciclo sui metadati -->
      <div *ngFor="let context of contextModificabile(); trackBy: trackByKey">

        <!-- Chiave formattata -->
        <p class="campo-key">{{ normalizzaChiave(context.key) }}</p>

        <!-- Valore in sola lettura (se non in editing) -->
        <p class="descrizione-testo" *ngIf="!isEditing">
          {{ context.value }}
        </p>

        <!-- Textarea solo per 'descrizione' (in modifica) -->
        <textarea
          *ngIf="isEditing && context.key === 'descrizione'"
          class="descrizione-textarea"
          [(ngModel)]="mediaContextMap[context.key]"
          [placeholder]="normalizzaChiave(context.key)"
          rows="5">
        </textarea>

        <!-- Input per altri campi (in modifica) -->
        <input
          *ngIf="isEditing && context.key !== 'descrizione'"
          class="campo-input"
          [(ngModel)]="mediaContextMap[context.key]"
          [placeholder]="normalizzaChiave(context.key)"
          [type]="isCampoNumerico(context.key) ? 'number' : 'text'" />
      </div>

      <!-- Pulsante di conferma modifiche -->
      <div *ngIf="modificaInAttesaDiConferma" class="azioni-finali">
        <button
          mat-stroked-button
          color="accent"
          class="btn-conferma"
          (click)="confermaModificaContext()">
          Conferma
        </button>
      </div>

      <!-- Azioni: modifica / salva / annulla -->
      <div class="azioni-popup">

        <!-- Attiva modifica -->
        <button
          mat-icon-button
          class="btn-edit-icon"
          matTooltip="Modifica"
          *ngIf="!isEditing"
          (click)="attivaModifica()"
          aria-label="Modifica">
          <mat-icon>edit</mat-icon>
        </button>

        <!-- Salva e annulla -->
        <div *ngIf="isEditing" class="azioni-editing">
          <button mat-raised-button color="primary" (click)="salvaModifica()">Salva</button>
          <button mat-button color="warn" (click)="annullaModifica()">Annulla</button>
        </div>

      </div>
    </ng-container>

    <!-- ===============================
         MODALITÀ SOLO VISUALIZZAZIONE
    ================================ -->
<!-- ===============================
     MODALITÀ VISUALIZZAZIONE (READ-ONLY)
     Mostra solo i metadati tranne 'descrizione'
=============================== -->
<ng-template #soloVisualizzazione>
  <div class="popup-container-only-view">

    <!-- Contenuto in sola lettura -->
    <div class="viewonly-content-wrapper">

      <!-- Ciclo su tutte le chiavi, ESCLUDENDO 'descrizione' -->
      <div
        class="context-entry"
        *ngFor="let context of contextVisualizzabile(); trackBy: trackByKey">

        <!-- Etichetta della chiave (es. Quantità, Tipo, ecc.) -->

        <!-- Valore corrispondente -->
        <span class="context-value">{{ context.value }}</span>
      </div>
    </div>
  </div>
</ng-template>



  </div> <!-- Fine scroll-container -->
</div> <!-- Fine popup-container -->
