<!-- ===============================
     CONTENITORE PRINCIPALE DEL POPUP
=============================== -->
<div class="popup-container">

  <!-- ===============================
       PULSANTE DI CHIUSURA
  ================================ -->
  <button class="chiudi-btn" (click)="chiudiDialog()" matTooltip="Chiudi" aria-label="Chiudi popup">
    <mat-icon>close</mat-icon>
  </button>

  <!-- ===============================
       CONTENITORE SCROLLABILE INTERNO
  ================================ -->
  <div class="scroll-container">

    <!-- ===============================
         MODALITÀ MODIFICA
    ================================ -->
    <ng-container *ngIf="!onlyViewInput; else soloVisualizzazione">

      <!-- Titolo -->
      <h2>Modifica dei metadati</h2>

      <!-- Ciclo sui metadati modificabili -->
      <div *ngFor="let context of contextModificabile(); trackBy: trackByKey">

        <!-- Etichetta del campo -->
        <p class="campo-key">{{ normalizzaChiave(context.key) }}</p>

        <!-- Valore in sola lettura -->
        <p class="descrizione-testo" *ngIf="!isEditing">
          {{ context.value }}
        </p>

        <!-- QUA MODIFICO I CAMPI-->
        <!-- Textarea per 'descrizione' -->
        <textarea *ngIf="isEditing && context.key === 'descrizione'" class="descrizione-textarea"
          [(ngModel)]="mediaContextMap[context.key]" [placeholder]="normalizzaChiave(context.key)" rows="5">
        </textarea>

        <!-- Input per altri campi -->
        <input *ngIf="isEditing && context.key !== 'descrizione'" class="campo-input"
          [(ngModel)]="mediaContextMap[context.key]" [placeholder]="normalizzaChiave(context.key)"
          [type]="isCampoNumerico(context.key) ? 'number' : 'text'" />
      </div>
<!-- Pulsante '+' semplice a sinistra -->
<div class="azione-aggiunta-metada-sinistra">
  <button *ngIf="isEditing" class="btn-plus-semplice" (click)="aggiungiNuovoMetadato()" matTooltip="Aggiungi metadato" aria-label="Aggiungi metadato">
    <mat-icon>add</mat-icon>
  </button>
</div>

      <!-- ===============================
           AZIONI UTENTE (piedino)
      ================================ -->
      <div class="azioni-popup-unificate">

        <!-- Pulsante di conferma (compare solo se c'è una modifica non ancora inviata) -->
        <button *ngIf="modificaInAttesaDiConferma" mat-stroked-button color="accent" class="btn-conferma"
          (click)="confermaModificaContext()">
          Conferma
        </button>

        <!-- Pulsante Modifica (riappare anche dopo un salvataggio) -->
        <button *ngIf="!isEditing" mat-icon-button class="btn-edit-icon" matTooltip="Modifica"
          (click)="attivaModifica()" aria-label="Modifica">
          <mat-icon>edit</mat-icon>
        </button>

        <!-- Pulsanti Salva / Annulla visibili solo in modalità editing -->
        <div *ngIf="isEditing" class="azioni-editing">
          <button mat-raised-button color="primary" (click)="salvaModifica()">Salva</button>
          <button mat-button color="warn" (click)="annullaModifica()">Annulla</button>
        </div>

      </div>
    </ng-container>

    <!-- ===============================
         MODALITÀ SOLO VISUALIZZAZIONE
    ================================ -->
    <ng-template #soloVisualizzazione>
      <div class="popup-container-only-view">
        <div class="viewonly-content-wrapper">

          <!-- Ciclo solo su 'descrizione' -->
          <div class="context-entry" *ngFor="let context of contextVisualizzabile(); trackBy: trackByKey">

            <span class="context-value">{{ context.value }}</span>
          </div>
        </div>
      </div>
    </ng-template>

  </div> <!-- Fine scroll-container -->

</div> <!-- Fine popup-container -->