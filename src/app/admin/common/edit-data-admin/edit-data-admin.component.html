<!-- Form principale -->
<form [formGroup]="contextFormGroup" (ngSubmit)="onConferma()">

  <!-- Contenitore scrollabile del contenuto del dialog -->
  <div class="contenuto-dialog">

    <!-- Pulsante di chiusura in alto a destra -->
    <button class="chiudi-btn" type="button" matTooltip="Chiudi" (click)="chiudiDialog()">
      <mat-icon>close</mat-icon>
    </button>

    <!-- Sezione: Metadati esistenti ereditati dal padre -->
    <div formGroupName="metadatiFromFather">
      <h3>Metadati esistenti</h3>

      <!-- Iterazione sui metadati esistenti -->
      <!-- I metadati con chiave 'angolazione' e 'type' vengono esclusi -->
      <ng-container *ngFor="let key of contextInputFromFatherKeys">
        <div class="form-row" *ngIf="key !== 'angolazione' && key !== 'type'">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ normalizzaChiave(normalizzaDisplayName(key)) }}</mat-label>

            <!-- Textarea solo per il campo 'descrizione' -->
            <textarea *ngIf="key === 'descrizione'" matInput [formControlName]="key" rows="3"
              [placeholder]="'Inserisci ' + key"></textarea>

            <!-- Input per tutti gli altri campi -->
            <input *ngIf="key !== 'descrizione'" matInput [formControlName]="key" [placeholder]="'Inserisci ' + key" />
          </mat-form-field>
        </div>
      </ng-container>
    </div>

    <!-- Sezione: Metadati aggiunti manualmente dall'utente -->
    <div formArrayName="metadatiAggiunti">
      <h3>Metadati aggiunti</h3>

      <!-- Iterazione sui campi dinamici (aggiunti dall'utente) -->
      <div *ngFor="let group of getMetadatiAggiuntiFormArray.controls; let i = index" [formGroupName]="i"
        class="form-row">

        <!-- Campo per la chiave -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Chiave</mat-label>
          <input matInput formControlName="key" placeholder="Es. colore" />

          <!-- Messaggio di errore: chiave duplicata -->
          <p class="error-chiave-duplicata" *ngIf="
            group.get('key')?.hasError('chiaviDuplicate') && group.get('key')?.touched">
            Chiave duplicata: esiste già un metadato con lo stesso nome.
          </p>

          <!-- Messaggio di errore: conflitto con chiave riservata -->
          <p class="error-chiave-duplicata" *ngIf="
            group.get('key')?.hasError('chiaviRiservate') && group.get('key')?.touched">
            Chiave già presente nei metadati esistenti.
          </p>

          <!-- Messaggio di errore: caratteri non validi -->
          <p class="error-chiave-duplicata" *ngIf="
            group.get('key')?.hasError('pattern') && group.get('key')?.touched">
            Inserisci caratteri validi.
          </p>
        </mat-form-field>

        <!-- Campo per il valore -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Valore</mat-label>
          <input matInput formControlName="value" placeholder="Es. rosso" />
        </mat-form-field>

      </div>
    </div>

    <!-- Pulsante per aggiungere un nuovo metadato dinamico -->
    <div class="add-button-container">
      <button mat-mini-fab color="primary" matTooltip="Aggiungi metadata" type="button" (click)="onAggiungiCampo()">
        <mat-icon>add</mat-icon>
      </button>
    </div>

  </div>

  <!-- Sezione inferiore con i pulsanti di azione -->
  <div class="azioni-dialog">
    <button mat-button type="button" (click)="chiudiDialog()">Annulla</button>
    <button mat-flat-button color="primary" type="submit" [disabled]="contextFormGroup.invalid">
      Conferma
    </button>
  </div>

</form>
