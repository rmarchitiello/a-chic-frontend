<div class="dialog-content">

  <!-- QUANDO IS DRAGGING E TRUE VUOL DIRE STIAMO CARICANDO IL FIGLIO EMETTE L'EVENTO DIVENTA FALSE SI TOGLIE LO SPINNER-->
  <div class="spinner-overlay" *ngIf="isDragging">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <button mat-icon-button class="chiudi-btn" [matTooltipClass]="'tooltip-custom'" matTooltip="Chiudi"
    (click)="chiudiDialog()">
    <mat-icon>close</mat-icon>
  </button>

  <!-- Contenitore flessibile di tutte le card -->
  <!-- =========================================================
     PREVIEW CONTAINER – mantiene la vecchia logica, ma supporta
     anche video  e audio (context.type = 'video' | 'audio' | 'image')
=========================================================-->
  <div class="preview-container">

    <!-- CARD generata per ogni URL frontale -->
    <div class="preview-card" *ngFor="let url of mediasUrlsFrontale" (mouseenter)="hoveredCard = url"
      (mouseleave)="hoveredCard = null">

      <div class="card-inner">

        <!-- Recupero il context relativo alla URL -->
        <ng-container *ngIf="contextMap[url] as context">

          <!-- ───── MEDIA PRINCIPALE ─────
             * image (default) : <img>
             * video           : <video controls>
             * audio           : cover + <audio controls>                  -->
          <ng-container [ngSwitch]="context.type || 'image'">

            <!-- immagine -->
            <img *ngSwitchCase="'image'" [src]="url" [alt]="'Immagine frontale di ' + context.display_name" />

            <!-- video -->
            <video *ngSwitchCase="'video'" [src]="url" controls playsinline preload="metadata"
              style="width:100%;max-height:200px;object-fit:contain;">
            </video>

            <!-- audio -->
            <ng-container *ngSwitchCase="'audio'">
              <!-- cover / icona -->
              <div class="audio-cover" style="width:100%;height:200px;
                        display:flex;align-items:center;justify-content:center;
                        background:#111;border-radius:10px;">
                <mat-icon style="color:#fff;font-size:64px;">graphic_eq</mat-icon>
              </div>
              <!-- player -->
              <audio class="audio-inline" [src]="url" controls style="width:100%;margin-top:6px;"></audio>
            </ng-container>

          </ng-container>
          <!-- ───────────── FINE MEDIA PRINCIPALE ───────────── -->

          <!-- ============  METADATI (stessi contenuti di prima) ============ -->
          <div class="media-display-name">
            <ng-container *ngFor="let contextFormatted of getOrderedFormattedEntries(context);
                     trackBy: trackByContextFormatted">

              <div class="context-entry" [class.is-editing]="contextFormatted.key !== 'type' &&
                                     campoInlineInEditing === url + '_' + contextFormatted.key">

                <!-- label visibile se non in editing (o se type) -->
                <strong class="context-label" *ngIf="contextFormatted.key === 'type' ||
                             campoInlineInEditing !== url + '_' + contextFormatted.key">
                  {{ contextFormatted.label }}:
                </strong>

                <!-- valore / input / cestino -->
                <div class="context-value" [class.full-row]="contextFormatted.key !== 'type' &&
                                      campoInlineInEditing === url + '_' + contextFormatted.key">

                  <!-- campo NON modificabile -->
                  <span *ngIf="contextFormatted.key === 'type'" class="preview-text non-editable"
                    matTooltip="Campo non modificabile" [matTooltipClass]="'tooltip-custom'">
                    {{ capitalizeFirstLetter(getPreview(contextFormatted.value)) }}
                  </span>

                  <!-- preview cliccabile -->
                  <span *ngIf="contextFormatted.key !== 'type' &&
                               campoInlineInEditing !== url + '_' + contextFormatted.key" class="preview-text"
                    (click)="editMetaDataInline(contextFormatted, url)" [matTooltip]="contextFormatted?.value"
                    [matTooltipDisabled]="!isLongText(contextFormatted?.value)" [matTooltipClass]="'tooltip-custom'"
                    matTooltipShowDelay="300">
                    {{ capitalizeFirstLetter(getPreview(contextFormatted.value)) }}
                  </span>

                  <!-- modalità editing -->
                  <ng-container *ngIf="contextFormatted.key !== 'type' &&
                                       campoInlineInEditing === url + '_' + contextFormatted.key">

                    <mat-form-field appearance="outline" class="inline-edit-form-field">
                      <!-- numero per quantita -->
                      <ng-container *ngIf="contextFormatted.key === 'quantita'; else testoGenerico">
                        <input matInput type="number" min="0" step="1" inputmode="numeric"
                          [formControl]="formControlsInline[url + '_' + contextFormatted.key]"
                          (blur)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          (keydown.enter)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          [placeholder]="contextFormatted.label" />
                      </ng-container>

                      <!-- testo per gli altri campi -->
                      <ng-template #testoGenerico>
                        <input matInput type="text" [formControl]="formControlsInline[url + '_' + contextFormatted.key]"
                          (blur)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          (keydown.enter)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          [placeholder]="contextFormatted.label" />
                      </ng-template>

                      <!-- errori -->
                      <mat-error *ngIf="formControlsInline[url + '_' + contextFormatted.key]?.hasError('required')">
                        Campo obbligatorio
                      </mat-error>
                      <mat-error *ngIf="formControlsInline[url + '_' + contextFormatted.key]?.hasError('pattern')">
                        Valore non valido
                      </mat-error>
                    </mat-form-field>

                    <!-- cestino -->
                    <button type="button" class="delete-metadata-btn"
                      [attr.aria-label]="'Rimuovi ' + contextFormatted.label"
                      matTooltip="Rimuovi {{ contextFormatted.label }}" [matTooltipClass]="'tooltip-custom'" (click)="rimuoviMetadatoInline(context,
                                                         contextFormatted.key,
                                                         contextFormatted.label,
                                                         url)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </ng-container>
                </div>
              </div>

            </ng-container>
            <!-- aggiungo il bottone per aggiungere i nuovi metadati dinamici che sono dei form array-->
            <button 
                class="add-metadata-button" 
                matTooltip="Aggiungi i campi" 
                [matTooltipClass]="'tooltip-custom'"
                (click)="aggiuntiMetadati(url)">
              <mat-icon>add</mat-icon>
            </button>

          </div>

          <!-- MINIATURE SECONDARIE (image | video | audio) -->
          <ng-container *ngIf="mapUrlsNoFrontali[url] as immaginiSecondarie">

            <div class="non-frontali-overlay" [class.visible]="hoveredCard === url">

              <!-- se esistono file secondari -->
              <ng-container *ngIf="immaginiSecondarie.length; else noViews">

                <!-- ◀︎ PREV -->
                <button class="nav-btn prev-btn" mat-icon-button (click)="prevSecondaryImage(url)"
                  *ngIf="immaginiSecondarie.length > 1">
                  <mat-icon>chevron_left</mat-icon>
                </button>

                <!-- ▸ THUMBNAIL DINAMICA -->
                <ng-container [ngSwitch]="context.type || 'image'">

                  <!-- IMG ------------------------------------------------------------ -->
                  <img *ngSwitchCase="'image'" class="img-secondaria"
                    [src]="immaginiSecondarie[currentSecondaryIndex[url]]"
                    [alt]="'Vista alternativa di ' + context.display_name" />

                  <!-- VIDEO ---------------------------------------------------------- -->
                  <video *ngSwitchCase="'video'" controls class="img-secondaria"
                    [src]="immaginiSecondarie[currentSecondaryIndex[url]]" muted loop playsinline controls>
                  </video>

                  <!-- AUDIO ---------------------------------------------------------- -->
                  <div *ngSwitchCase="'audio'" controls class="img-secondaria audio-thumb">
                    <mat-icon style="font-size:32px;">graphic_eq</mat-icon>
                  </div>

                </ng-container>

                <!-- ▶︎ NEXT -->
                <button class="nav-btn next-btn" mat-icon-button (click)="nextSecondaryImage(url)"
                  *ngIf="immaginiSecondarie.length > 1">
                  <mat-icon>chevron_right</mat-icon>
                </button>

              </ng-container>

              <!-- messaggio se non ci sono viste secondarie -->
              <ng-template #noViews>
                <div class="messaggio-nessuna-immagine">
                  Non sono disponibili ulteriori viste per questo elemento.
                </div>
              </ng-template>

            </div>
          </ng-container>



        </ng-container>
      </div>
    </div>

    <!-- CARD “Aggiungi” per upload/drag-and-drop -->
    <div class="preview-card upload-add-card" (click)="apriPopUpUploadMedia()" [class.drag-over]="isDragging"
      (dragenter)="onDragEnter($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)">

      <span class="add-icon" matTooltip="Aggiungi Prodotto" [matTooltipClass]="'tooltip-custom'"
        *ngIf="!isDragging">Aggiungi prodotto</span>

      <span class="add-icon" matTooltip="Aggiungi Prodotto" [matTooltipClass]="'tooltip-custom'"
        *ngIf="isDragging">Rilascia prodotto</span>
    </div>

  </div>

</div>


<!-- input One-Way binding-->
<app-upload-data-admin hidden *ngIf="isDragging" [inputFolderFromEdiorOneWayBinding]="folderInput"
  [droppedByEditorOneWayBinding]="true" [filesDroppedFromEditorOneWayBinding]="fileArray"
  [typeMediaFromEditorOneWayBinding]="mediaTypeDropped"
  (eventoChiudiUpload)="gestisciChiusuraUpload($event)"></app-upload-data-admin>