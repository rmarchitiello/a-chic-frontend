<div class="dialog-content">

  <!-- Spinner caricamento figli -->
  <div class="spinner-overlay" *ngIf="isUploading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Pulsante Chiudi -->
  <button mat-icon-button class="chiudi-btn" [matTooltipClass]="'tooltip-custom'" matTooltip="Chiudi"
    (click)="chiudiDialog()">
    <mat-icon>close</mat-icon>
  </button>

  <!-- Griglia card -->
  <div class="preview-container" (click)="onChiudiMetaDati()">

    <!-- CARD per ogni URL frontale 
    Perche stop propagation Perche quando clicco per espandere i metadati vieme abilitata la variabile espandiMetadati con la url corrente che va ad abilitare 
    la classe expanded che chiude gli altri e visualizza solo quelli correnti alla chiusura la classe viene disabilitata
    
    Pero se clicco fuori la card voglio che si chiude tutto pero poi devo stoppare l'evento altrimenti non si aprono piu le card
    -->
    <div class="preview-card" *ngFor="let url of mediasUrlsFrontale" [class.expanded]="espandiMetaDati === url"
      (click)="$event.stopPropagation()">
      <div class="card-inner">

        <!-- Context della card -->
        <ng-container *ngIf="contextMap[url] as context">

          <!-- =========================================================
               GALLERIA MEDIA (carousel singolo riquadro)
               - -1  : frontale (url)
               - 0+  : secondarie (mapUrlsNoFrontali[url][i])
               - Frecce: visibili se esistono secondarie
          ========================================================== -->
          <section class="media-gallery">

            <!-- PULSANTI PER AZIONI SU UNA SINGOLA CARD QUANDO CLICCO ESCONO VARIE OPZIONI CANCELLA E DOWNLOAD CARD-->
            <!-- Pulsante azioni card -->
            <div class="card-actions">
              <mat-spinner *ngIf="isDeletingMap[url]" diameter="24"></mat-spinner>
              <!-- Pulsante menu -->
              <button class="action-button" [matMenuTriggerFor]="menu" mat-icon-button>
                <mat-icon>more_vert</mat-icon>
              </button>

              <!-- Menu principale -->
              <mat-menu #menu="matMenu" class="menu-card-actions">
                <button mat-menu-item [matMenuTriggerFor]="menuScarica">
                  <mat-icon>download</mat-icon>
                  <span>Scarica</span>
                </button>
                <button mat-menu-item [matMenuTriggerFor]="menuCancella">
                  <mat-icon>delete</mat-icon>
                  <span>Elimina</span>
                </button>
              </mat-menu>

              <!-- Sottomenu scarica
               fa comparire il tasto di scaricare tutti i media solo se ci sono anche altre angolazioni -->
              <mat-menu #menuScarica="matMenu" class="menu-card-actions scarica">
                <button mat-menu-item (click)="scaricaMedia('image')">Scarica il media corrente</button>
                <button mat-menu-item *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0"
                  (click)="scaricaMedia('image')">Scarica tutto</button>
              </mat-menu>

              <!-- Sottomenu cancella -->
              <mat-menu #menuCancella="matMenu" class="menu-card-actions cancella">
                <!-- Elimina solo l’angolazione corrente -->
                <button mat-menu-item (click)="cancellaMedia(getUrlCorrente(url), false)">
                  Elimina il media corrente
                </button>

                <!-- Elimina tutto: angolazioni + frontale -->
                <button mat-menu-item *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0"
                  (click)="cancellaMedia(url, true)">
                  Elimina tutto
                </button>
              </mat-menu>
            </div>



            <!-- ===== Frecce (solo se esistono secondarie) ===== -->
            <ng-container *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0">
              <button class="gallery-nav-btn prev" mat-icon-button (click)="prevSecondaryImage(url)"
                aria-label="Slide precedente">
                <mat-icon>chevron_left</mat-icon>
              </button>

              <button class="gallery-nav-btn next" mat-icon-button (click)="nextSecondaryImage(url)"
                aria-label="Slide successiva">
                <mat-icon>chevron_right</mat-icon>
              </button>
            </ng-container>
            <div class="gallery-viewport" [ngSwitch]="context.type || 'image'">

              <!-- identifico il media frontale -->
              <span class="front-badge"
                *ngIf="(mapUrlsNoFrontali[url]?.length || 0) === 0 || (currentSecondaryIndex[url] ?? -1) < 0">
                <span class="dot"></span> Frontale
              </span>
              <!-- ===== IMMAGINE ===== -->
              <ng-container *ngSwitchCase="'image'">
                <!-- Se esiste almeno una secondaria e l'indice è valido (>= 0) uso la secondaria -->
                <ng-container
                  *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0 && (currentSecondaryIndex[url] ?? -1) >= 0; else frontaleImg">
                  <img class="gallery-media" [src]="mapUrlsNoFrontali[url]![currentSecondaryIndex[url]!]"
                    [alt]="'Vista alternativa di ' + context.display_name" />
                </ng-container>
                <!-- Fallback: frontale -->
                <ng-template #frontaleImg>
                  <img class="gallery-media" [src]="url" [alt]="'Immagine frontale di ' + context.display_name" />
                </ng-template>
              </ng-container>

              <!-- ===== VIDEO ===== -->
              <ng-container *ngSwitchCase="'video'">
                <ng-container
                  *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0 && (currentSecondaryIndex[url] ?? -1) >= 0; else frontaleVideo">
                  <video class="gallery-media" [src]="mapUrlsNoFrontali[url]![currentSecondaryIndex[url]!]" controls
                    playsinline preload="metadata">
                  </video>
                </ng-container>
                <ng-template #frontaleVideo>
                  <video class="gallery-media" [src]="url" playsinline preload="metadata">
                  </video>
                </ng-template>
              </ng-container>
              <!-- ===== Contatore (include il frontale) ===== -->
              <div class="gallery-counter" *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0">
                {{ (currentSecondaryIndex[url] ?? -1) + 2 }}
                /
                {{ 1 + (mapUrlsNoFrontali[url]?.length || 0) }}
              </div>

              <!-- ===== AUDIO ===== -->
              <ng-container *ngSwitchCase="'audio'">
                <div class="audio-cover">
                  <mat-icon>graphic_eq</mat-icon>
                </div>
                <ng-container
                  *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0 && (currentSecondaryIndex[url] ?? -1) >= 0; else frontaleAudio">
                  <audio class="audio-inline" [src]="mapUrlsNoFrontali[url]![currentSecondaryIndex[url]!]">
                  </audio>
                </ng-container>
                <ng-template #frontaleAudio>
                  <audio class="audio-inline" [src]="url">
                  </audio>
                </ng-template>
              </ng-container>
            </div>

            <!-- pulsante per espandere i metadata-->
            <div class="metadata-toggle-container">
              <p class="media-display-name-preview">{{ capitalizeFirstLetter(context.display_name || '') }}</p>

              <button class="toggle-metadata-btn show-btn" *ngIf="espandiMetaDati !== url"
                (click)="onEspandiMetadati(url)" matTooltip="Espandi Metadata" [matTooltipClass]="'tooltip-custom'">
                <mat-icon>expand_more</mat-icon>
              </button>

              <button class="toggle-metadata-btn show-btn" *ngIf="espandiMetaDati === url" (click)="onChiudiMetaDati()"
                matTooltip="Riduci Metadata" [matTooltipClass]="'tooltip-custom'">
                <mat-icon>expand_less</mat-icon>
              </button>
            </div>


          </section>


          <!-- =========================================================
               METADATA (editing inline)
          ========================================================== -->
          <div class="media-display-name" [class.expanded]="espandiMetaDati === url">

            <ng-container
              *ngFor="let contextFormatted of getOrderedFormattedEntries(context); trackBy: trackByContextFormatted">
              <!-- mostro i metadati solo di quella card hoverata per la url-->
              <div class="context-entry" [class.is-editing]="contextFormatted.key !== 'type' &&
                        campoInlineInEditing === url + '_' + contextFormatted.key &&
                        !isAddingMetadataFromForm">

                <!-- LABEL -->
                <strong class="context-label" *ngIf="contextFormatted.key === 'type' ||
                 campoInlineInEditing !== url + '_' + contextFormatted.key">
                  {{ contextFormatted.label }}:
                </strong>

                <!-- VALORE / EDIT -->
                <div class="context-value" [class.full-row]="contextFormatted.key !== 'type' &&
                         campoInlineInEditing === url + '_' + contextFormatted.key &&
                         !isAddingMetadataFromForm">

                  <!-- Non modificabile -->
                  <span *ngIf="contextFormatted.key === 'type'" class="preview-text non-editable"
                    matTooltip="Campo non modificabile" [matTooltipClass]="'tooltip-custom'">
                    {{ capitalizeFirstLetter(getPreview(contextFormatted.value)) }}
                  </span>

                  <!-- Preview cliccabile -->
                  <span *ngIf="contextFormatted.key !== 'type' &&
                 campoInlineInEditing !== url + '_' + contextFormatted.key" class="preview-text"
                    (click)="editMetaDataInline(contextFormatted, url)" [matTooltip]="contextFormatted?.value"
                    [matTooltipDisabled]="!isLongText(contextFormatted?.value)" [matTooltipClass]="'tooltip-custom'"
                    matTooltipShowDelay="300">
                    {{ capitalizeFirstLetter(getPreview(contextFormatted.value)) }}
                  </span>

                  <!-- Modalità editing -->
                  <ng-container *ngIf="contextFormatted.key !== 'type' &&
                         campoInlineInEditing === url + '_' + contextFormatted.key">

                    <mat-form-field appearance="outline" class="inline-edit-form-field">
                      <!-- numero per quantita -->
                      <ng-container *ngIf="contextFormatted.key === 'quantita'; else testoGenerico">
                        <input matInput type="number" min="0" step="1" inputmode="numeric"
                          [formControl]="formControlsInline[url + '_' + contextFormatted.key]"
                          (blur)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          (keydown.enter)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          [placeholder]="contextFormatted.label" />
                      </ng-container>

                      <!-- testo generico -->
                      <ng-template #testoGenerico>
                        <input matInput type="text" [formControl]="formControlsInline[url + '_' + contextFormatted.key]"
                          (blur)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          (keydown.enter)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          [placeholder]="contextFormatted.label" />
                      </ng-template>

                      <!-- errori -->
                      <mat-error *ngIf="formControlsInline[url + '_' + contextFormatted.key]?.hasError('required')">
                        Campo obbligatorio
                      </mat-error>
                      <mat-error *ngIf="formControlsInline[url + '_' + contextFormatted.key]?.hasError('pattern')">
                        Valore non valido
                      </mat-error>
                    </mat-form-field>

                    <!-- Azioni inline -->
                    <button type="button" class="conferma-metadata-btn"
                      [attr.aria-label]="'Conferma modifica ' + contextFormatted.label"
                      matTooltip="Conferma modifica {{ contextFormatted.label }}" [matTooltipClass]="'tooltip-custom'"
                      (click)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)">
                      <mat-icon>check</mat-icon>
                    </button>

                    <button type="button" class="annulla-metadata-btn"
                      [attr.aria-label]="'Annulla modifica ' + contextFormatted.label"
                      matTooltip="Annulla modifica {{ contextFormatted.label }}" [matTooltipClass]="'tooltip-custom'"
                      (click)="annullaValoreInline(context, contextFormatted.key, url)">
                      <mat-icon>close</mat-icon>
                    </button>

                    <button type="button" class="delete-metadata-btn"
                      [attr.aria-label]="'Rimuovi ' + contextFormatted.label"
                      [matTooltip]="'Rimuovi ' + contextFormatted.label" [matTooltipClass]="'tooltip-custom'"
                      (click)="rimuoviMetadatoInline(context, contextFormatted.key, contextFormatted.label, url)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </ng-container>
                </div>
              </div>



            </ng-container>

            <!-- =========================================================
                 AGGIUNTA METADATI (box visibile e contrastato)
            ========================================================== -->
            <div class="add-metadata-row full-row">

              <!-- Pulsante “+” -->
              <button type="button" class="add-metadata-button" aria-label="Aggiungi metadato"
                [matTooltip]="isAddingMetadataFromForm ? 'Completa l’aggiunta in corso prima di aggiungerne altri' : 'Aggiungi un metadato'"
                [matTooltipClass]="'tooltip-custom'"
                [disabled]="isAddingMetadataFromForm && currentMetadataTargetUrl !== url"
                (click)="aggiungiMetadati(url)">
                <mat-icon>add</mat-icon>
              </button>

              <!-- Form di aggiunta (solo se attivo per questa card) -->
              <div *ngIf="isAddingMetadataFromForm && currentMetadataTargetUrl === url" class="add-metadata-form"
                [formGroup]="metadataFormGroup">

                <!-- Chiave -->
                <mat-form-field appearance="outline" class="inline-edit-form-field">
                  <mat-label>Chiave (es. materiale)</mat-label>
                  <input matInput formControlName="key" placeholder="Es. materiale" cdkFocusInitial
                    (keydown.enter)="salvaMetadato(url)">
                </mat-form-field>

                <!-- Valore -->
                <mat-form-field appearance="outline" class="inline-edit-form-field">
                  <mat-label>Valore (es. pelle)</mat-label>
                  <input matInput formControlName="valore" placeholder="Es. pelle" (blur)="salvaMetadato(url)"
                    (keydown.enter)="salvaMetadato(url)">
                </mat-form-field>

                <!-- Azioni -->
                <div class="add-metadata-actions">
                  <button type="button" class="confirm-btn" aria-label="Conferma" matTooltip="Conferma"
                    [matTooltipClass]="'tooltip-custom'" (click)="salvaMetadato(url)">
                    <mat-icon>check</mat-icon>
                  </button>

                  <button type="button" class="cancel-btn" aria-label="Annulla" matTooltip="Annulla"
                    [matTooltipClass]="'tooltip-custom'" (click)="annullaAggiunta()">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>

          </div>

        </ng-container>
      </div>
    </div>

    <!-- CARD upload/drag-and-drop -->
    <div class="upload-dropzone" (click)="apriPopUpUploadMedia()" [class.drag-over]="isDragging"
      (dragenter)="onDragEnter($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)">
      <div class="upload-content">
        <mat-icon *ngIf="!uploadSuccess" class="upload-icon">cloud_upload</mat-icon>
        <mat-icon *ngIf="uploadSuccess" class="upload-icon">cloud_done</mat-icon>

        <p class="upload-text" *ngIf="!isDragging">
          Trascina qui i file<br><strong>oppure clicca</strong>
        </p>
        <p class="upload-text" *ngIf="isDragging">Rilascia i file per caricarli</p>
      </div>
    </div>


  </div>
</div>

<!-- Upload dialog (one-way bindings) -->
<app-upload-data-admin hidden *ngIf="showUploadComponent" [inputFolderFromEdiorOneWayBinding]="folderInput"
  [droppedByEditorOneWayBinding]="true" [filesDroppedFromEditorOneWayBinding]="fileArray"
  [typeMediaFromEditorOneWayBinding]="mediaTypeDropped" (eventoChiudiUpload)="gestisciChiusuraUpload($event)">
</app-upload-data-admin>