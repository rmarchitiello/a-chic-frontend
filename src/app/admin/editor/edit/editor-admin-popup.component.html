<div class="dialog-content">
  <div class="spinner-overlay" *ngIf="isUploading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div class="top-actions">
    <button *ngIf="tutteLeUrl.length > 0" mat-icon-button class="icon-btn elimina-tutto"
      [matTooltipClass]="'tooltip-custom'" matTooltip="Elimina tutti i media"
      (click)="cancellaMedia('not defined url',false,true)" [disabled]="isUploading || disabledMoreVertButton">
      <mat-icon>delete</mat-icon>
    </button>
    <button [disabled]="isUploading || disabledMoreVertButton" mat-icon-button class="icon-btn chiudi-btn"
      [matTooltipClass]="'tooltip-custom'" matTooltip="Chiudi" (click)="chiudiDialog()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- INIZIO SEZIONE GUIDA-->
<mat-card class="spigazione-editor guida-card" role="region" aria-labelledby="guida-btn">
  <!-- Unico bottone: √® lui la "Guida rapida" -->
  <div class="guida-header">
    <button id="guida-btn"
            mat-stroked-button
            class="btn-guida-rapida"
            color="primary"
            (click)="showGuida()"
            [attr.aria-expanded]="isGuidaVisibile"
            aria-controls="guida-content"
            matTooltip="{{ isGuidaVisibile ? 'Riduci' : 'Espandi' }}"
            [matTooltipClass]="'tooltip-custom'">
      <mat-icon aria-hidden="true">help</mat-icon>
      <mat-icon class="chev" aria-hidden="true">{{ isGuidaVisibile ? 'expand_less' : 'expand_more' }}</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>

  <!-- Corpo guida -->
  <div id="guida-content" *ngIf="isGuidaVisibile" class="guida-body">
    <!-- Chips formati supportati -->
    <div class="supported">
      <span class="label">Supporta:</span>
      <mat-chip-set aria-label="Formati supportati">
        <mat-chip color="primary" selected>Immagini</mat-chip>
        <mat-chip color="primary" selected>Video</mat-chip>
        <mat-chip color="primary" selected>Audio</mat-chip>
      </mat-chip-set>
    </div>

    <!-- Steps con icone -->
    <ul class="helper-steps">
      <li>
        <mat-icon class="step-ico" aria-hidden="true">cloud_upload</mat-icon>
        <div>
          <strong>Carica solo anteprime</strong>:
          usa il riquadro <strong>verde</strong> ‚ÄúSolo anteprime‚Äù. Trascina i file oppure fai clic per selezionarli.
        </div>
      </li>

      <li>
        <mat-icon class="step-ico" aria-hidden="true">layers</mat-icon>
        <div>
          <strong>Carica anteprima + angolazioni</strong>:
          usa il riquadro <strong>blu</strong>. Trascina pi√π file dello stesso prodotto (frontale + laterali) o fai clic per scegliere.
        </div>
      </li>

      <li>
        <mat-icon class="step-ico" aria-hidden="true">move_up</mat-icon>
        <div>
          <strong>Aggiungi angolazioni su una card esistente</strong>:
          trascina i nuovi file direttamente sulla <strong>card</strong> del media per aggiungere altre viste.
        </div>
      </li>

      <li>
        <mat-icon class="step-ico" aria-hidden="true">edit</mat-icon>
        <div>
          <strong>Modifica i dati</strong>:
          clicca su prezzo, materiale, quantit√† o descrizione per modificarli.
          Conferma con <span aria-label="conferma">‚úì</span> o annulla con <span aria-label="annulla">√ó</span>.
          Aggiungi nuovi metadati con <span aria-label="aggiungi">+</span> o rimuovili con <span aria-label="elimina">üóë</span>.
        </div>
      </li>

      <li>
        <mat-icon class="step-ico" aria-hidden="true">more_vert</mat-icon>
        <div>
          <strong>Azioni rapide</strong>:
          dal menu <span aria-hidden="true">‚ãÆ</span> della card puoi scaricare o eliminare,
          e impostare un media come <strong>Anteprima</strong>.
        </div>
      </li>
    </ul>

    <!-- Nota finale -->
    <div class="helper-note">
      <mat-icon class="i" aria-hidden="true">info</mat-icon>
      Se vuoi ordinare i prodotti da visualizzare puoi anche spostare le <strong>card</strong> tra loro
    </div>
  </div>
</mat-card>



    <!-- FINE SEZIONE GUIDA-->


  <!-- Allinea le due dropzone pi√π a destra (su mobile tornano centrate) -->
  <div class="dropzones-row dropzones-right">
    <!-- DROP ZONE PER ANTEPRIME-->
    <!-- se clicco il div mi chiama input hidden sotto che mi apre la finetra di upload-->
    <!--
  Riga contenitore che CENTRA orizzontalmente le due dropzone.
  (Ricordati di avere lo SCSS per .dropzones-row con display:flex; justify-content:center; gap:24px;)
-->
    <div class="dropzones-row">

      <!-- =========================================
       DROP ZONE PER SOLE ANTEPRIME
       - Click su tutta l'area => apre l'input file nascosto
       - Stati usati:
         * isDraggingAnteprime              -> evidenzia drag-over
         * isDroppedAnteprime               -> mostra "Sto caricando" solo qui
         * uploadSuccessAnteprime           -> icona cloud_done solo qui per 2s
     ========================================= -->
      <div (click)="inputDaInvocareAnteprime.click()" class="upload-dropzone anteprime"
        [class.drag-over]="isDraggingAnteprime" (dragenter)="onDragEnter('anteprime')"
        (dragover)="onDragOver($event,'anteprime')" (dragleave)="onDragLeave($event,'anteprime')"
        (drop)="onDrop($event,'anteprime')">

        <!--
      Input file NASCOSTO:
      - apertura nativa (Explorer/Finder/Foto) al click della dropzone
      - uso (change) perch√© i file sono disponibili SOLO dopo la selezione
      - ctx = 'anteprime' per distinguere la zona
    -->
        <input #inputDaInvocareAnteprime hidden type="file" multiple
          (change)="filesCaricatiManualmente($event,'anteprime')">

        <div class="upload-content">
          <!-- Icona stato: di default nuvola; su successo (solo per questa DZ) cloud_done -->
          <mat-icon *ngIf="!uploadSuccessAnteprime" class="upload-icon">cloud_upload</mat-icon>
          <mat-icon *ngIf="uploadSuccessAnteprime" class="upload-icon">cloud_done</mat-icon>

          <!-- Testi di stato (solo per questa DZ) -->
          <p class="upload-text" *ngIf="!isDraggingAnteprime && !isDroppedAnteprime">
            <strong>Trascina qui i tuoi file o fai clic per scegliere dal dispositivo e caricare solo le
              ANTEPRIME</strong>
          </p>
          <p class="upload-text" *ngIf="isDraggingAnteprime && !isDroppedAnteprime">
            <strong>Rilascia i file per caricarli</strong>
          </p>
          <p class="upload-text" *ngIf="isDroppedAnteprime">
            <strong>Sto caricando</strong>
          </p>
        </div>
      </div>

      <!-- =========================================
       DROP ZONE PER ANTEPRIME + ALTRE ANGOLAZIONI
       - Click su tutta l'area => apre l'input file nascosto
       - Stati usati:
         * isDraggingAnteprimePiuAltre         -> evidenzia drag-over
         * isDroppedAnteprimePiuAltre          -> mostra "Sto caricando" solo qui
         * uploadSuccessAnteprimePiuAltre      -> icona cloud_done solo qui per 2s
     ========================================= -->
      <div (click)="inputDaInvocareAnteprimeEAltre.click()" class="upload-dropzone anteprime-altre"
        [class.drag-over]="isDraggingAnteprimePiuAltre" (dragenter)="onDragEnter('anteprime-altre')"
        (dragover)="onDragOver($event,'anteprime-altre')" (dragleave)="onDragLeave($event,'anteprime-altre')"
        (drop)="onDrop($event,'anteprime-altre')">

        <!--
      Input file NASCOSTO:
      - apertura nativa
      - uso (change) perch√© i file sono disponibili SOLO dopo la selezione
      - ctx = 'anteprime-altre' per distinguere la zona
    -->
        <input #inputDaInvocareAnteprimeEAltre hidden type="file" multiple
          (change)="filesCaricatiManualmente($event,'anteprime-altre')">

        <div class="upload-content">
          <!-- Icona stato per QUESTA DZ -->
          <mat-icon *ngIf="!uploadSuccessAnteprimePiuAltre" class="upload-icon">cloud_upload</mat-icon>
          <mat-icon *ngIf="uploadSuccessAnteprimePiuAltre" class="upload-icon">cloud_done</mat-icon>

          <!-- Testi di stato (solo per questa DZ) -->
          <p class="upload-text" *ngIf="!isDraggingAnteprimePiuAltre && !isDroppedAnteprimePiuAltre">
            <strong>Trascina qui i tuoi file o fai clic per scegliere dal dispositivo e caricare le ANTEPRIME pi√π ALTRE
              ANGOLAZIONI</strong>
          </p>
          <p class="upload-text" *ngIf="isDraggingAnteprimePiuAltre && !isDroppedAnteprimePiuAltre">
            <strong>Rilascia i file per caricarli</strong>
          </p>
          <p class="upload-text" *ngIf="isDroppedAnteprimePiuAltre">
            <strong>Sto caricando</strong>
          </p>
        </div>
      </div>

    </div>
  </div>











  <!-- Griglia card -->
  <div class="preview-container" (click)="onChiudiMetaDati()">


    <!-- CARD per ogni URL frontale 
    Perche stop propagation Perche quando clicco per espandere i metadati vieme abilitata la variabile espandiMetadati con la url corrente che va ad abilitare 
    la classe expanded che chiude gli altri e visualizza solo quelli correnti alla chiusura la classe viene disabilitata
    
    Pero se clicco fuori la card voglio che si chiude tutto pero poi devo stoppare l'evento altrimenti non si aprono piu le card
    -->
    <div class="preview-card" *ngFor="let url of mediasUrlsFrontale" [class.expanded]="espandiMetaDati === url"
      (dragenter)="onDragEnterOnCard($event, url)" (dragover)="onDragOverOnCard($event, url)"
      (drop)="onDropOnCard($event,url)" [class.drag-drop-event]="isDraggingOnCard === url"
      (click)="$event.stopPropagation()">
      <div class="card-inner">

        <!-- Context della card recuperando il context dalla url corrente-->
        <ng-container *ngIf="contextMap[url] as context">

          <!-- =========================================================
               GALLERIA MEDIA (carousel singolo riquadro)
               - -1  : frontale (url)
               - 0+  : secondarie (mapUrlsNoFrontali[url][i])
               - Frecce: visibili se esistono secondarie
          ========================================================== -->
          <section class="media-gallery">

            <!-- PULSANTI PER AZIONI SU UNA SINGOLA CARD QUANDO CLICCO ESCONO VARIE OPZIONI CANCELLA E DOWNLOAD CARD-->
            <!-- Pulsante azioni card -->
            <div class="card-actions">
              <mat-spinner *ngIf="isDeletingMap[url]" diameter="24"></mat-spinner>
              <!-- Pulsante menu -->
              <button mat-icon-button class="action-button" [disabled]="disabledMoreVertButton"
                [matMenuTriggerFor]="disabledMoreVertButton ? null : menu">
                <mat-icon>more_vert</mat-icon>
              </button>


              <!-- Menu principale -->
              <mat-menu #menu="matMenu" class="menu-card-actions">
                <button mat-menu-item [matMenuTriggerFor]="menuScarica">
                  <mat-icon>download</mat-icon>
                  <span>Scarica</span>
                </button>
                <button mat-menu-item [matMenuTriggerFor]="menuCancella">
                  <mat-icon>delete</mat-icon>
                  <span>Elimina</span>
                </button>
              </mat-menu>

              <!-- Sottomenu scarica
               fa comparire il tasto di scaricare tutti i media solo se ci sono anche altre angolazioni -->
              <mat-menu #menuScarica="matMenu" class="menu-card-actions scarica">
                <button mat-menu-item (click)="scaricaMedia(getUrlCorrente(url),false,  context.display_name )">Scarica
                  il media corrente</button>
                <button mat-menu-item *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0"
                  (click)="scaricaMedia(url,true, context.display_name)">Scarica tutto</button>
              </mat-menu>

              <!-- Sottomenu cancella -->
              <mat-menu #menuCancella="matMenu" class="menu-card-actions cancella">
                <!-- Elimina solo l‚Äôangolazione corrente -->
                <button mat-menu-item (click)="cancellaMedia(getUrlCorrente(url), false,false)">
                  Elimina il media corrente
                </button>

                <!-- Elimina tutto: angolazioni + frontale -->
                <button mat-menu-item *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0"
                  (click)="cancellaMedia(url, true,false)">
                  Elimina tutto
                </button>
              </mat-menu>
            </div>



            <!-- ===== Frecce (solo se esistono secondarie) ===== -->
            <ng-container *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0">
              <button class="gallery-nav-btn prev" mat-icon-button (click)="prevSecondaryImage(url)"
                aria-label="Slide precedente">
                <mat-icon>chevron_left</mat-icon>
              </button>

              <button class="gallery-nav-btn next" mat-icon-button (click)="nextSecondaryImage(url)"
                aria-label="Slide successiva">
                <mat-icon>chevron_right</mat-icon>
              </button>
            </ng-container>


            <!-- Determina il tipo effettivo del media attualmente visibile (image, video, audio) -->
            <div class="gallery-viewport" [ngSwitch]="getTipoMediaCorrente(getUrlCorrente(url))">

              <!-- Identifica il media frontale ‚Äì l‚Äôindice frontale √® -1 -->
              <div class="contenitore-anteprima-altre-angolazioni">
                <span class="anteprima-badge"
                  *ngIf="(mapUrlsNoFrontali[url]?.length || 0) === 0 || (currentSecondaryIndex[url] ?? -1) < 0">
                  Anteprima
                </span>

                <button *ngIf="!((mapUrlsNoFrontali[url]?.length || 0) === 0 || (currentSecondaryIndex[url] ?? -1) < 0)"
                  type="button" class="button-rendi-anteprima" (click)="rendiMediaFrontale(url, getUrlCorrente(url))">
                  Imposta come anteprima
                </button>
              </div>

              <!-- ===== IMMAGINE ===== -->
              <ng-container *ngSwitchCase="'image'">
                <img class="gallery-media" [src]="getUrlCorrente(url)"
                  [alt]="'Vista immagine di ' + context.display_name" />
              </ng-container>

              <!-- ===== VIDEO ===== -->
              <ng-container *ngSwitchCase="'video'">
                <video class="gallery-media" [src]="getUrlCorrente(url)" controls playsinline preload="metadata">
                </video>
              </ng-container>

              <!-- ===== AUDIO ===== -->
              <ng-container *ngSwitchCase="'audio'">
                <div class="audio-cover">
                  <mat-icon>graphic_eq</mat-icon>
                </div>
                <audio class="audio-inline" [src]="getUrlCorrente(url)" controls>
                </audio>
              </ng-container>

              <!-- ===== CONTATORE (include anche il frontale come primo) ===== -->
              <div class="gallery-counter" *ngIf="(mapUrlsNoFrontali[url]?.length || 0) > 0">
                {{ (currentSecondaryIndex[url] ?? -1) + 2 }}
                /
                {{ 1 + (mapUrlsNoFrontali[url]?.length || 0) }}
              </div>

            </div>


            <!-- pulsante per espandere i metadata-->
            <div class="metadata-toggle-container">
              <p class="media-display-name-preview">{{ capitalizeFirstLetter(context.display_name || '') }}</p>

              <button class="toggle-metadata-btn show-btn" *ngIf="espandiMetaDati !== url"
                (click)="onEspandiMetadati(url)" matTooltip="Espandi Metadata" [matTooltipClass]="'tooltip-custom'">
                <mat-icon>expand_more</mat-icon>
              </button>

              <button class="toggle-metadata-btn show-btn" *ngIf="espandiMetaDati === url" (click)="onChiudiMetaDati()"
                matTooltip="Riduci Metadata" [matTooltipClass]="'tooltip-custom'">
                <mat-icon>expand_less</mat-icon>
              </button>
            </div>


          </section>


          <!-- =========================================================
               METADATA (editing inline)
          ========================================================== -->
          <div class="media-display-name" [class.expanded]="espandiMetaDati === url">

            <ng-container
              *ngFor="let contextFormatted of getOrderedFormattedEntries(context); trackBy: trackByContextFormatted">
              <!-- mostro i metadati solo di quella card hoverata per la url-->
              <div class="context-entry" [class.is-editing]="contextFormatted.key !== 'type' &&
                        campoInlineInEditing === url + '_' + contextFormatted.key &&
                        !isAddingMetadataFromForm">

                <!-- LABEL -->
                <strong class="context-label" *ngIf="contextFormatted.key === 'type' ||
                 campoInlineInEditing !== url + '_' + contextFormatted.key">
                  {{ contextFormatted.label }}:
                </strong>

                <!-- VALORE / EDIT -->
                <div class="context-value" [class.full-row]="contextFormatted.key !== 'type' &&
                         campoInlineInEditing === url + '_' + contextFormatted.key &&
                         !isAddingMetadataFromForm">

                  <!-- Non modificabile -->
                  <span *ngIf="contextFormatted.key === 'type'" class="preview-text non-editable"
                    matTooltip="Campo non modificabile" [matTooltipClass]="'tooltip-custom'">
                    {{ capitalizeFirstLetter(getPreview(contextFormatted.value)) }}
                  </span>

                  <!-- Preview cliccabile -->
                  <span *ngIf="contextFormatted.key !== 'type' &&
                 campoInlineInEditing !== url + '_' + contextFormatted.key" class="preview-text"
                    (click)="editMetaDataInline(contextFormatted, url)" [matTooltip]="contextFormatted?.value"
                    [matTooltipDisabled]="!isLongText(contextFormatted?.value)" [matTooltipClass]="'tooltip-custom'"
                    matTooltipShowDelay="300">
                    {{ capitalizeFirstLetter(getPreview(contextFormatted.value)) }}
                  </span>

                  <!-- Modalit√† editing -->
                  <ng-container *ngIf="contextFormatted.key !== 'type' &&
                         campoInlineInEditing === url + '_' + contextFormatted.key">

                    <mat-form-field appearance="outline" class="inline-edit-form-field">
                      <!-- numero per quantita -->
                      <ng-container *ngIf="contextFormatted.key === 'quantita'; else testoGenerico">
                        <input matInput type="number" min="0" step="1" inputmode="numeric"
                          [formControl]="formControlsInline[url + '_' + contextFormatted.key]"
                          (blur)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          (keydown.enter)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          [placeholder]="contextFormatted.label" />
                      </ng-container>

                      <!-- testo generico -->
                      <ng-template #testoGenerico>
                        <input matInput type="text" [formControl]="formControlsInline[url + '_' + contextFormatted.key]"
                          (blur)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          (keydown.enter)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)"
                          [placeholder]="contextFormatted.label" />
                      </ng-template>

                      <!-- errori -->
                      <mat-error *ngIf="formControlsInline[url + '_' + contextFormatted.key]?.hasError('required')">
                        Campo obbligatorio
                      </mat-error>
                      <mat-error *ngIf="formControlsInline[url + '_' + contextFormatted.key]?.hasError('pattern')">
                        Valore non valido
                      </mat-error>
                    </mat-form-field>

                    <!-- Azioni inline -->
                    <button type="button" class="conferma-metadata-btn"
                      [attr.aria-label]="'Conferma modifica ' + contextFormatted.label"
                      matTooltip="Conferma modifica {{ contextFormatted.label }}" [matTooltipClass]="'tooltip-custom'"
                      (click)="confermaValoreInline(context, contextFormatted.key, contextFormatted.label, url)">
                      <mat-icon>check</mat-icon>
                    </button>

                    <button type="button" class="annulla-metadata-btn"
                      [attr.aria-label]="'Annulla modifica ' + contextFormatted.label"
                      matTooltip="Annulla modifica {{ contextFormatted.label }}" [matTooltipClass]="'tooltip-custom'"
                      (click)="annullaValoreInline(context, contextFormatted.key, url)">
                      <mat-icon>close</mat-icon>
                    </button>

                    <button type="button" class="delete-metadata-btn"
                      [attr.aria-label]="'Rimuovi ' + contextFormatted.label"
                      [matTooltip]="'Rimuovi ' + contextFormatted.label" [matTooltipClass]="'tooltip-custom'"
                      (click)="rimuoviMetadatoInline(context, contextFormatted.key, contextFormatted.label, url)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </ng-container>
                </div>
              </div>



            </ng-container>

            <!-- =========================================================
                 AGGIUNTA METADATI (box visibile e contrastato)
            ========================================================== -->
            <div class="add-metadata-row full-row">

              <!-- Pulsante ‚Äú+‚Äù -->
              <button type="button" class="add-metadata-button" aria-label="Aggiungi metadato"
                [matTooltip]="isAddingMetadataFromForm ? 'Completa l‚Äôaggiunta in corso prima di aggiungerne altri' : 'Aggiungi un metadato'"
                [matTooltipClass]="'tooltip-custom'"
                [disabled]="isAddingMetadataFromForm && currentMetadataTargetUrl !== url"
                (click)="aggiungiMetadati(url)">
                <mat-icon>add</mat-icon>
              </button>

              <!-- Form di aggiunta (solo se attivo per questa card) -->
              <div *ngIf="isAddingMetadataFromForm && currentMetadataTargetUrl === url" class="add-metadata-form"
                [formGroup]="metadataFormGroup">

                <!-- Chiave -->
                <mat-form-field appearance="outline" class="inline-edit-form-field">
                  <mat-label>Chiave (es. materiale)</mat-label>
                  <input matInput formControlName="key" placeholder="Es. materiale" cdkFocusInitial
                    (keydown.enter)="salvaMetadato(url)">
                </mat-form-field>

                <!-- Valore -->
                <mat-form-field appearance="outline" class="inline-edit-form-field">
                  <mat-label>Valore (es. pelle)</mat-label>
                  <input matInput formControlName="valore" placeholder="Es. pelle" (blur)="salvaMetadato(url)"
                    (keydown.enter)="salvaMetadato(url)">
                </mat-form-field>

                <!-- Azioni -->
                <div class="add-metadata-actions">
                  <button type="button" class="confirm-btn" aria-label="Conferma" matTooltip="Conferma"
                    [matTooltipClass]="'tooltip-custom'" (click)="salvaMetadato(url)">
                    <mat-icon>check</mat-icon>
                  </button>

                  <button type="button" class="cancel-btn" aria-label="Annulla" matTooltip="Annulla"
                    [matTooltipClass]="'tooltip-custom'" (click)="annullaAggiunta()">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>

          </div>

        </ng-container>
      </div>
    </div>

    <!-- CARD upload/drag-and-drop 
      Non uso al momento il pop up di upload ma trascino solo per il momento
          <div class="upload-dropzone" (click)="apriPopUpUploadMedia()" [class.drag-over]="isDragging"
 
    -->



  </div>
</div>

<!-- Upload dialog (one-way bindings) -->
<app-upload-data-admin hidden *ngIf="showUploadComponent" [inputFolderFromEdiorOneWayBinding]="folderInput"
  [droppedByEditorOneWayBinding]="true" [filesDroppedFromEditorOneWayBinding]="fileArray"
  [typeMediaFromEditorOneWayBinding]="mediaTypeDropped" (eventoChiudiUpload)="gestisciChiusuraUpload($event)">
</app-upload-data-admin>