<!-- ============================= -->
<!-- BLOCCO MOBILE PER ADMIN -->
<!-- ============================= -->
<div *ngIf="isMobile && isAdmin" class="mobile-blocked">
  <h2>Accesso ADMIN non disponibile su mobile</h2>
  <p>Per motivi di sicurezza e usabilità, accedi da un dispositivo desktop.</p>
</div>

<!-- ============================= -->
<!-- DESKTOP -->
<!-- ============================= -->
<ng-container *ngIf="!isMobile">

  <!-- Logout admin -->
  <div *ngIf="isAdmin" class="admin-logout">
    <button mat-stroked-button color="warn" (click)="logoutAdmin()">
      Esci da modalità admin
    </button>
    <button mat-stroked-button color="warn" (click)="refreshCache()">
      Refresh della cache
    </button>
        <!-- Spinner visibile solo durante il refresh -->
    <mat-progress-spinner
      *ngIf="isRefreshing"
      mode="indeterminate"
      diameter="24"
      strokeWidth="4"
      color="primary"
      style="margin-left: 10px;">
    </mat-progress-spinner>
  </div>

  <!-- Header -->
  <app-header></app-header>

  <!-- Pulsante apertura/chiusura sidenav -->
  <div class="sidenav-handler" (click)="desktopSidenavOpenFun()" [class.aperta]="desktopSidenavOpen">
    <mat-icon>{{ desktopSidenavOpen ? 'chevron_left' : 'chevron_right' }}</mat-icon>
  </div>

  <!-- Layout principale -->
  <mat-sidenav-container class="desktop-sidenav-container">

    <!-- ====================== -->
    <!-- SIDENAV DESKTOP -->
    <!-- ====================== -->
    <mat-sidenav #sidenavDesktop mode="side" [(opened)]="desktopSidenavOpen" class="desktop-sidenav">
      <div class="sidenav-content">

<!-- Azioni admin: visibili solo su desktop e solo se admin -->
<div *ngIf="isAdmin" class="admin-sidenav-actions">
  <button mat-stroked-button color="primary"
          (click)="apriAdminFolderPopUp()"
          matTooltip="Visualizza tutte le cartelle e aggiungine di nuove (max 3 livelli)">
    <mat-icon>create_new_folder</mat-icon>
    Gestisci cartelle
  </button>
  <small class="hint">Formato: livello1[/livello2[/livello3]]</small>
</div>

        <!-- Livello 1: categorie root -->
        <ng-container *ngFor="let categoriaNew of categorieNew">

          <!-- Nodo L1: click = apri/chiudi ramo 'categoriaNew' -->
          <div class="sidenav-categoria-desktop"
               (click)="saveCategoriaAndToggle(categoriaNew)">
            {{ capitalizeFirstLetter(categoriaNew) }}
          </div>

          <!-- Livello 2: figli diretti di L1 -->
          <!-- Rimane aperto se L1 è selezionato o se l'espanso è un suo discendente -->
          <div class="sidenav-sottocategorie livello-2" *ngIf="isPathOpen(categoriaNew)">

            <!-- Ogni 'childPath' è un path completo tipo 'borse/conchiglia' -->
            <div class="sidenav-sottocategoria"
                 *ngFor="let childPath of getChildrenPaths(mapFolderWithCategorieESottoCategorie, categoriaNew)"
                 (click)="saveCategoriaAndToggle(childPath); $event.stopPropagation()">

              <!-- etichetta = ultimo segmento leggibile -->
              {{ capitalizeFirstLetter(childPath.split('/').slice(-1)[0]) }}

              <!-- Livello 3: figli diretti di L2 -->
              <div class="sidenav-sottocategorie livello-3" *ngIf="isPathOpen(childPath)">

                <!-- Ogni 'grandChildPath' è un path completo tipo 'borse/conchiglia/perlata' -->
                <!-- click = NAVIGA passando il path completo (un solo argomento) -->
                <div class="sidenav-sottocategoria"
                     *ngFor="let grandChildPath of getChildrenPaths(mapFolderWithCategorieESottoCategorie, childPath)"
                     (click)="goToAndCloseSideNav(grandChildPath); $event.stopPropagation()">
                  {{ capitalizeFirstLetter(grandChildPath.split('/').slice(-1)[0]) }}
                </div>

              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </mat-sidenav>

    <!-- ====================== -->
    <!-- CONTENUTO DESKTOP -->
    <!-- ====================== -->
    <mat-sidenav-content>
      <div class="main-layout">
        <div class="desktop-page-container" [ngClass]="{ 'home-page': isHomeRoute }">
          <router-outlet></router-outlet>
        </div>
        <app-footer *ngIf="!isMobile"></app-footer>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- Chat desktop -->
 <!-- togliere commento x abilitare <app-live-chat></app-live-chat> -->
</ng-container>

<!-- ============================= -->
<!-- MOBILE (solo se non admin) -->
<!-- ============================= -->
<ng-container *ngIf="isMobile && !isAdmin">

  <!-- Header mobile: apre/chiude la sidenav mobile -->
  <app-header (menuToggle)="sidenav.toggle()"></app-header>

  <mat-sidenav-container class="sidenav-container">

    <!-- ====================== -->
    <!-- SIDENAV MOBILE -->
    <!-- ====================== -->
    <mat-sidenav #sidenav mode="over" [(opened)]="mobileMenuOpen">
      <div class="sidenav-content">

        <!-- Livello 1: categorie root -->
        <ng-container *ngFor="let categoriaNew of categorieNew">

          <!-- Nodo L1 mobile: evidenzia se il ramo è aperto -->
          <div class="sidenav-categoria"
               [class.attiva]="isPathOpen(categoriaNew)"
               (click)="saveCategoriaAndToggle(categoriaNew)">
            {{ capitalizeFirstLetter(categoriaNew) }}
          </div>

          <!-- Livello 2 mobile -->
          <div class="sotto-container" *ngIf="isPathOpen(categoriaNew)" [@expandCollapse]>

            <!-- Ogni 'childPath' è un path completo tipo 'borse/conchiglia' -->
            <div class="sotto-categoria"
                 *ngFor="let childPath of getChildrenPaths(mapFolderWithCategorieESottoCategorie, categoriaNew)"
                 (click)="saveCategoriaAndToggle(childPath); $event.stopPropagation()">
              {{ capitalizeFirstLetter(childPath.split('/').slice(-1)[0]) }}

              <!-- Livello 3 mobile: foglie -->
              <div class="filtro-container" *ngIf="isPathOpen(childPath)" [@expandCollapse]>

                <!-- click = NAVIGA passando il path completo (un solo argomento) -->
                <button class="filtro-categoria"
                        *ngFor="let grandChildPath of getChildrenPaths(mapFolderWithCategorieESottoCategorie, childPath)"
                        (click)="goToAndCloseSideNav(grandChildPath); $event.stopPropagation()">
                  {{ capitalizeFirstLetter(grandChildPath.split('/').slice(-1)[0]) }}
                </button>

              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </mat-sidenav>

    <!-- ====================== -->
    <!-- CONTENUTO MOBILE -->
    <!-- ====================== -->
    <mat-sidenav-content>
      <div class="mobile-page-container">
        <router-outlet></router-outlet>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- Footer + Chat mobile -->
  <app-footer></app-footer>
 <!-- togliere commento x abilitare <app-live-chat></app-live-chat> -->
</ng-container>
