<!-- =============================================================================
     APP COMPONENT TEMPLATE (UNICO)
     - Un solo <mat-sidenav> con template condiviso per mobile e desktop
     - Logica di visibilità e comportamento gestita da isMobile / isAdmin e dallo SCSS
     - Le differenze visive tra mobile/desktop si gestiscono via media queries
     ============================================================================ -->

<!-- =============================================================================
     BLOCCO: ACCESSO ADMIN BLOCCATO SU MOBILE
     - Se l’utente è admin e si trova su mobile, mostriamo un messaggio e nascondiamo
       il resto del layout per evitare l’uso dell’area admin su dispositivi mobili.
     ============================================================================ -->
<div *ngIf="isMobile && isAdmin" class="mobile-blocked">
  <h2>Accesso ADMIN non disponibile su mobile</h2>
  <p>Per motivi di sicurezza e usabilità, accedi da un dispositivo desktop.</p>
</div>

<!-- =============================================================================
     LAYOUT PRINCIPALE (UNICO)
     - Reso visibile solo se NON siamo nel caso “admin su mobile”
     - Contiene:
       1) Overlay di caricamento durante il refresh cache
       2) Pulsanti fissi per gestione admin (logout / refresh)
       3) Sidenav container condiviso
          3.1) Sidenav unico (#sidenav) con albero categorie
          3.2) Contenuto scroller con banner, header e corpo pagina (router-outlet)
     ============================================================================ -->
<ng-container *ngIf="!(isMobile && isAdmin)">

  <!-- ===========================================================================
       OVERLAY DI CARICAMENTO
       - Visibile quando isRefreshing è true (es. durante refresh della cache)
       ======================================================================== -->
  <div class="spinner-overlay" *ngIf="isRefreshing">
    <mat-progress-spinner mode="indeterminate" diameter="48" strokeWidth="4" color="primary">
    </mat-progress-spinner>
  </div>

  <!-- ===========================================================================
       AZIONI ADMIN FISSE
       - Visibili quando l’utente è in modalità admin (tipicamente su desktop)
       - Puoi regolare la visibilità via CSS per nasconderle su mobile, se necessario
       ======================================================================== -->
  <div *ngIf="isAdmin" class="admin-managing">
    <button mat-stroked-button color="warn" (click)="setViewMode()">
      Modalita visualizzazione
    </button>
    <button mat-stroked-button color="warn" (click)="logoutAdmin()">
      Esci da modalità admin
    </button>
    <button mat-stroked-button color="warn" (click)="refreshCache()">
      Refresh della cache
    </button>
  </div>

  <!-- ===========================================================================
       CONTENITORE SIDENAV CONDIVISO
       - Unico container per mobile e desktop
       - Le dimensioni, lo scrolling e altri dettagli si regolano via SCSS e media query
       ======================================================================== -->
  <mat-sidenav-container class="sidenav-container" (backdropClick)="sidenav.close()"
    > <!-- oscura lo schermo -->

    <!-- =======================================================================
         SIDENAV UNICO
         - Reference unica #sidenav
         - Il comportamento cambia in base a isMobile:
             * mode="over"  su mobile  (menu a scomparsa)
             * mode="side"  su desktop (menu affiancato o persistente)
         - Lo stato di apertura è legato alle variabili esistenti:
             * mobileMenuOpen  quando isMobile === true
             * desktopSidenavOpen quando isMobile === false
         - openedChange:
             * Sincronizza la variabile corretta in base a isMobile
             * Chiama onDrawerState(opened) per blocco/sblocco dello scroll
         ==================================================================== -->
    <mat-sidenav class="app-sidenav" #sidenav [mode]="isMobile ? 'over' : 'side'"
      [opened]="isMobile ? mobileMenuOpen : desktopSidenavOpen"
      (openedChange)="(isMobile ? mobileMenuOpen = $event : desktopSidenavOpen = $event); onDrawerState($event)"
      (keydown.escape)="sidenav.close()">

      <!-- =====================================================================
           CONTENUTO DEL MENU LATERALE (ALBERO CATEGORIE)
           - Struttura unica per mobile/desktop
           - Le classi sono comuni; differenze estetiche via SCSS
           - Comportamento:
             * Click su livello 1: apre/chiude rami o naviga se foglia
             * Click su livello 2: come sopra
             * Click su livello 3 (bottoni): naviga e chiude il menu
           ================================================================== -->
      <div class="sidenav-content">
        <button (click)="sidenav.close()" class="chiudi-btn-sidenav">
          <mat-icon>close</mat-icon>
        </button>
        <!-- Azioni admin opzionali nel menu (visibili solo se admin e non mobile) -->
        <div *ngIf="isAdmin && !isMobile" class="admin-sidenav-actions">
          <button mat-stroked-button color="primary" (click)="apriAdminFolderPopUp()"
            matTooltip="Visualizza tutte le cartelle e aggiungine di nuove (max 3 livelli)">
            <mat-icon>create_new_folder</mat-icon>
            Gestisci cartelle
          </button>
          <small class="hint">Formato: livello1[/livello2[/livello3]]</small>
        </div>

        <!-- Livello 1: categorie root -->
        <ng-container *ngFor="let categoriaNew of categorieNew">

          <!-- Nodo L1 -->
          <div class="sidenav-categoria" [class.attiva]="isPathOpen(categoriaNew)"
            (click)="saveCategoriaAndToggle(categoriaNew)">
            {{ capitalizeFirstLetter(categoriaNew) }}
          </div>

          <!-- Contenitore L2: visibile se il path L1 è aperto -->
          <div class="sotto-container" *ngIf="isPathOpen(categoriaNew)" [@expandCollapse]>

            <!-- Ogni childPath è un path completo (es. 'borse/conchiglia') -->
            <div class="sotto-categoria"
              *ngFor="let childPath of getChildrenPaths(mapFolderWithCategorieESottoCategorie, categoriaNew)"
              (click)="saveCategoriaAndToggle(childPath); $event.stopPropagation()">
              {{ capitalizeFirstLetter(childPath.split('/').slice(-1)[0]) }}

              <!-- Contenitore L3: visibile se il path L2 è aperto -->
              <div class="filtro-container" *ngIf="isPathOpen(childPath)" [@expandCollapse]>

                <!-- Ogni grandChildPath è un path completo (es. 'borse/conchiglia/perlata') -->
                <button class="filtro-categoria"
                  *ngFor="let grandChildPath of getChildrenPaths(mapFolderWithCategorieESottoCategorie, childPath)"
                  (click)="goToAndCloseSideNav(grandChildPath); $event.stopPropagation()">
                  {{ capitalizeFirstLetter(grandChildPath.split('/').slice(-1)[0]) }}
                </button>

              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </mat-sidenav>

    <!-- =======================================================================
         CONTENUTO SCORREVOLE (DESTRA)
         - Contiene top banner, header e corpo pagina
         - cdkScrollable: necessario per la tua logica di scroll dispatcher
         ==================================================================== -->
    <mat-sidenav-content cdkScrollable>

      <!-- Banner superiore (opzionale, già in uso) -->
      <app-top-banner></app-top-banner>

      <!-- Header unico:
           - L’icona hamburger (se presente nel componente) emette (menuToggle)
           - Il toggle agisce sempre sullo stesso #sidenav -->
      <app-header (menuToggle)="sidenav.toggle()"></app-header>

      <!-- Contenitore principale pagina:
           - Usa una classe unica (page-container); se necessario puoi mantenere
             classi legacy in parallelo per non rompere lo SCSS esistente -->
      <div class="page-container" [ngClass]="{ 'home-page': isHomeRoute }">
        <router-outlet></router-outlet>
        <app-footer></app-footer>
        <!-- <app-live-chat></app-live-chat> -->
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</ng-container>