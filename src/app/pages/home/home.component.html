<!-- =============================================================================
     HOME TEMPLATE UNICO (desktop + mobile) — VERSIONE DINAMICA CON NGX-FLICKING
     - Si itera su iMieICaroselli: ogni voce configura un carosello/sezione
     - Ogni carosello espone: car.options, car.plugins, car.data.items, car.otherOption
     - Gli eventi mouse/touch delegano la gestione swipe al TS (saveAsseX / checkIfScrollDxorSx)
     - Le frecce e i pallini sono visibili solo se otherOption.haveArrow / haveBullet sono true
     - Requisiti lato TS:
         trackByIndex(index: number, _: any): number
         hasMedia(media: MediaMeta[]): boolean
         getMediaFrontale(media: MediaMeta[]): string | null
         saveAsseX(event: any): void
         checkIfScrollDxorSx(event: any, indexCurrentFlickingRefs: number): void
         onChangedCarosello(event: any, className: string): void
         apriPopUpEditorAdmin(key: string): void
     ============================================================================ -->

<section class="home" aria-label="Sezione principale Home">
  <div class="home-container">

    <!-- Iterazione dinamica su tutti i caroselli configurati -->
    <ng-container *ngFor="let car of carousels; let i = index; trackBy: trackByIndex">

      <!-- Header sezione (opzionale: titolo + pulsante admin) -->
      <div class="carousel-section-header" *ngIf="car.otherOption.titoloSezione || isAdmin">
        <!-- Pulsante admin -->
        <button
          *ngIf="isAdmin"
          mat-icon-button
          class="edit-admin-icon"
          (click)="apriPopUpEditorAdmin(car.otherOption.editKey)"
          [matTooltip]="car.otherOption.tooltip"
          [matTooltipClass]="'tooltip-custom'">
          <mat-icon>edit</mat-icon>
        </button>

        <!-- Titolo sezione -->
        <h2 *ngIf="car.otherOption.titoloSezione">
          {{ car.otherOption.titoloSezione }}
        </h2>
      </div>

      <!-- Istanza NGX-FLICKING -->
       <!-- Classe wrapper dinamica -->
      <ngx-flicking
        #flickingTag
        [options]="car.options"
        [plugins]="car.plugins"
        [ngClass]="car.otherOption.wrapperClass" 
        (changed)="onChangedCarosello($event, car.otherOption.onChangedCarosello)"
        aria-roledescription="carousel"
        [attr.aria-label]="car.otherOption.titoloSezione || 'Carosello'"
      >

        <!-- Pannelli -->
         <!-- Classe panel dinamica carosello-panel c e sempre e poi applico la classe dinamica-->
        <div
          flicking-panel
          *ngFor="let item of car.data.items; trackBy: trackByIndex"
          [ngClass]="['carosello-panel', car.otherOption.panelClass]" 
        >
          <!-- Renderizza media solo se presenti -->
          <ng-container *ngIf="hasMedia(item.media); else noMediaTpl">
            <ng-container *ngIf="getMediaFrontale(item.media) as src">
              <ng-container [ngSwitch]="item.context?.type">

                <!-- Immagine -->
                <img
                  *ngSwitchCase="'image'"
                  [src]="src"
                  [alt]="item.context?.display_name || ''"
                />

                <!-- Video -->
                <video
                  *ngSwitchCase="'video'"
                  [src]="src"
                  playsinline
                  muted
                  preload="auto"
                ></video>

                <!-- Audio -->
                <audio
                  *ngSwitchCase="'audio'"
                  [src]="src"
                  controls
                ></audio>

                <!-- Fallback: immagine -->
                <img
                  *ngSwitchDefault
                  [src]="src"
                  [alt]="item.context?.display_name || ''"
                />

              </ng-container>
            </ng-container>
          </ng-container>

          <!-- Placeholder se non ci sono media -->
          <ng-template #noMediaTpl>
            <div class="media-placeholder">Nessun media disponibile</div>
          </ng-template>
        </div>

        <!-- Frecce di navigazione 
         Quando haveArrow è true allora class.none = false non aggiunge la classe 
         non uso ngif sugli span perche cosi rendo il dom nascosto altrimenti ho problemi di rendering del carosello-->
        <span
          in-viewport
          class="flicking-arrow-prev"
          [class.none]="!car.otherOption.haveArrow"
          aria-label="Slide precedente"
        ></span>
        <span
          in-viewport
          class="flicking-arrow-next"
          [class.none]="!car.otherOption.haveArrow"
          aria-label="Slide successiva"
        ></span>

        <!-- Paginazione -->
        <div
          in-viewport
          class="flicking-pagination"
          [class.none]="!car.otherOption.haveBullet"
          aria-label="Paginazione carosello"
        ></div>
      </ngx-flicking>

    </ng-container>
  </div>
</section>
