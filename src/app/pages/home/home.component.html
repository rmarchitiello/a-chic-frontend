<!-- =============================================================================
     HOME TEMPLATE UNICO (desktop + mobile) — VERSIONE DINAMICA CON NGX-FLICKING
     Obiettivo: il titolo (h2) di ogni carosello è un overlay CENTRATO e BIANCO,
     visibile su TUTTE le slide del carosello.
     Nota chiave: l’overlay del titolo NON è figlio di <ngx-flicking>, ma un suo fratello
     dentro un WRAPPER comune, così non “scorre via” con la camera di Flicking.

     - Itero su `carousels`: ogni voce configura un carosello/sezione.
     - Ogni carosello espone: car.options, car.plugins, car.data.items, car.otherOption.
     - Eventi: (ready) e (changed) gestiscono frecce e animazioni via TS.
     - Visibilità frecce/pallini: controllata da car.hasArrow / car.hasBullet e dalle mappe
       setArrowSxMap[i] (true = prev visibile) / setArrowDxMap[i] (true = next nascosta).

     Requisiti lato TS:
       trackByIndex(index: number, _: any): number
       hasMedia(media: MediaMeta[]): boolean
       getMediaFrontale(media: MediaMeta[]): string | null
       onReadyCarosello(event: any, car: ImieiCaroselli, i: number): void
       onChangedCarosello(event: any, car: ImieiCaroselli, i: number): void
       apriPopUpEditorAdmin(key: string): void
       setArrowSxMap: Record<number, boolean>  // true = freccia sinistra visibile
       setArrowDxMap: Record<number, boolean>  // true = freccia destra nascosta

     Accessibilità e layering:
       - <ngx-flicking> usa aria-roledescription="carousel" e aria-label dal titolo.
       - L’overlay del titolo è aria-hidden="true" (elemento visivo, non interattivo).
       - L’overlay non intercetta i tocchi (pointer-events: none in SCSS) e sta sotto le frecce.
   ============================================================================ -->

<section class="home" aria-label="Sezione principale Home">
  <div class="home-container">

    <!-- Iterazione dinamica su tutti i caroselli configurati -->
    <ng-container *ngFor="let car of carousels; let i = index; trackBy: trackByIndex">

      <!-- Header sezione esterno al carosello:
           qui mantengo SOLO il pulsante admin. Il titolo è gestito come overlay nel wrapper. -->
      <div class="carousel-section-header" *ngIf="isAdmin">
        <button
          mat-icon-button
          class="edit-admin-icon"
          (click)="apriPopUpEditorAdmin(car.otherOption.editKey)"
          [matTooltip]="car.otherOption.tooltip"
          [matTooltipClass]="'tooltip-custom'">
          <mat-icon>edit</mat-icon>
        </button>
      </div>

      <!-- WRAPPER CAROSELLO:
           - Questo contenitore è l’“ancora” per SIA il carosello SIA l’overlay del titolo.
           - Deve avere position: relative (gestito via SCSS sulle classi wrapper).
           - Uso [ngClass] per applicare la classe wrapper desiderata (es. 'flicking-hero' o 'flicking-default'). -->
      <div class="carousel-wrapper" [ngClass]="car.otherOption.wrapperClass">

        <!-- NGX-FLICKING (solo i pannelli e i controlli del carosello):
             - Dentro <ngx-flicking> metto esclusivamente i pannelli (div[flicking-panel]) e gli UI interni
               come frecce e paginazione. L’overlay del titolo NON sta qui per evitare che scorra. -->
        <ngx-flicking
          #flickingTags
          [options]="car.options"
          [plugins]="car.plugins"
          (ready)="onReadyCarosello($event, car, i)"
          (changed)="onChangedCarosello($event, car, i)"
          aria-roledescription="carousel"
          [attr.aria-label]="car.otherOption.titoloSezione || 'Carosello'">

          <!-- PANNELLI DEL CAROSELLO -->
          <div
            flicking-panel
            *ngFor="let item of car.data.items; trackBy: trackByIndex"
            [ngClass]="['carosello-panel', car.otherOption.panelClass]">

            <!-- Renderizzo media solo se presenti -->
            <ng-container *ngIf="hasMedia(item.media); else noMediaTpl">
              <ng-container *ngIf="getMediaFrontale(item.media) as src">
                <ng-container [ngSwitch]="item.context?.type">

                  <!-- Immagine -->
                  <img *ngSwitchCase="'image'" [src]="src" [alt]="item.context?.display_name || ''" />

                  <!-- Video -->
                  <video *ngSwitchCase="'video'" [src]="src" playsinline muted preload="auto"></video>

                  <!-- Audio -->
                  <audio *ngSwitchCase="'audio'" [src]="src" controls></audio>

                  <!-- Fallback: immagine -->
                  <img *ngSwitchDefault [src]="src" [alt]="item.context?.display_name || ''" />

                </ng-container>
              </ng-container>
            </ng-container>

            <!-- Placeholder se non ci sono media -->
            <ng-template #noMediaTpl>
              <div class="media-placeholder">Nessun media disponibile</div>
            </ng-template>
          </div>

          <!-- FRECCE DI NAVIGAZIONE:
               - Non uso *ngIf per non rimuovere i nodi dal DOM; nascondo con classe .none.
               - Logica visibilità via mappe indicizzate per i: setArrowSxMap[i] / setArrowDxMap[i]. -->
          <span
            in-viewport
            class="flicking-arrow-prev"
            [class.none]="(!car.hasArrow || !setArrowSxMap[i])"
            aria-label="Slide precedente">
          </span>

          <span
            in-viewport
            class="flicking-arrow-next"
            [class.none]="(!car.hasArrow || setArrowDxMap[i])"
            aria-label="Slide successiva">
          </span>

          <!-- PAGINAZIONE:
               - Mostro i bullet solo se richiesti.
               - Lo stile/posizionamento è gestito via SCSS; per l’hero è in assoluto dentro il wrapper. -->
          <div
            in-viewport
            class="flicking-pagination"
            [class.none]="!car.hasBullet"
            aria-label="Paginazione carosello">
          </div>
        </ngx-flicking>

        <!-- TITOLO OVERLAY (FRATELLO DI <ngx-flicking>, NON FIGLIO):
             - Copre l’area del carosello e resta fermo mentre scorrono le slide.
             - pointer-events: none in SCSS per non bloccare swipe/click.
             - z-index inferiore alle frecce per lasciarle interattive. -->
        <div
          *ngIf="car.otherOption.titoloSezione"
          class="carousel-title-overlay"
          aria-hidden="true">
          <h2 class="carousel-title">{{ car.otherOption.titoloSezione }}</h2>
        </div>

      </div> <!-- /carousel-wrapper -->

    </ng-container>
  </div>
</section>
