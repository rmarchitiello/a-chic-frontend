<!-- =============================================================================
     HOME TEMPLATE UNICO (desktop + mobile) — VERSIONE DINAMICA CON NGX-FLICKING

     Obiettivi:
     1) Il titolo (h2) della sezione è posizionato SOPRA il carosello (introduzione).
     2) Il "panel name" (display_name del media) è mostrato al CENTRO di OGNI pannello,
        come caption interna al singolo flicking-panel.

     Direttiva di reveal:
     - [appRevealOnScroll] applica una transizione quando l’elemento entra in viewport.
     - Accetta:
         • una stringa/classe singola (es. "reveal-up"), oppure
         • un oggetto di opzioni { addClass, threshold, rootMargin, once, initialClass }.
     - Richiede nel CSS la classe di stato iniziale .is-reveal-init e la/e classe/i finale/i
       (es. .reveal-up) come da SCSS condiviso.

     Note architetturali:
     - Iterazione su `carousels` (factory): ogni voce configura un carosello/sezione.
     - Ogni carosello espone: car.options, car.plugins, car.data.items, car.otherOption.
     - Eventi: (ready) e (changed) gestiscono frecce e animazioni via TS.
     - Visibilità frecce/pallini: da car.hasArrow / car.hasBullet e mappe setArrowSxMap / setArrowDxMap.

     Requisiti lato TS già previsti:
       trackByIndex(index: number, _: any): number
       hasMedia(media: MediaMeta[]): boolean
       getMediaFrontale(media: MediaMeta[]): string | null
       onReadyCarosello(event: any, car: ImieiCaroselli, i: number): void
       onChangedCarosello(event: any, car: ImieiCaroselli, i: number): void
       apriPopUpEditorAdmin(key: string): void
       setArrowSxMap: Record<number, boolean>
       setArrowDxMap: Record<number, boolean)

     Accessibilità:
       - <ngx-flicking> usa aria-roledescription="carousel".
       - Se presente il titolo di sezione, il carosello lo referenzia via aria-labelledby.
       - Le caption per-pannello sono aria-hidden="true" e non intercettano tocchi.
   ============================================================================ -->

<section class="home" aria-label="Sezione principale Home">
  <div class="home-container">

    <!-- Iterazione dinamica su tutti i caroselli -->
    <ng-container *ngFor="let car of carousels; let i = index; trackBy: trackByIndex">

      <!-- Header sezione: solo pulsante admin -->
      <div class="carousel-section-header" *ngIf="isAdmin">
        <!-- EDIT: solo se la sezione ha dati -->
        <button *ngIf="car.data.items.length > 0" mat-icon-button class="edit-admin-icon"
          (click)="apriPopUpEditorAdmin(car.otherOption.editKey)" [matTooltip]="car.otherOption.tooltip"
          [matTooltipClass]="'tooltip-custom'">
          <mat-icon>edit</mat-icon>
        </button>
      </div>


      <!-- TITOLO SEZIONE (introduzione sopra il carosello)
           - Direttiva appRevealOnScroll in forma SEMPLICE (stringa):
             all’entrata in viewport rimuove .is-reveal-init e aggiunge .reveal-up. -->
      <div *ngIf="car.otherOption.titoloSezione" [ngClass]="car.otherOption.wrapperTitoloSezioneClass"
        appRevealOnScroll="reveal-up">
        <h2 [ngClass]="car.otherOption.titoloSezioneClass" [attr.id]="'carousel-title-' + i">
          {{ car.otherOption.titoloSezione }}
        </h2>
      </div>

      <!-- WRAPPER CAROSELLO
           - Direttiva appRevealOnScroll in forma AVANZATA (oggetto opzioni):
             once:true → rivela una sola volta
             threshold:0.15 → innesca quando ~15% è visibile
             rootMargin:'0px 0px -12% 0px' → anticipa leggermente l’innesco
           - Nota: la classe finale 'reveal-up' deve esistere nel tuo SCSS. -->
      <div [ngClass]="car.otherOption.wrapperClass"
        [appRevealOnScroll]="{ addClass: 'reveal-up', once: true, threshold: 0.15, rootMargin: '0px 0px -12% 0px' }">

        <!-- NGX-FLICKING -->
        <ngx-flicking #flickingTags [options]="car.options" [plugins]="car.plugins"
          (ready)="onReadyCarosello($event, car, i)" (changed)="onChangedCarosello($event, car, i)"
          aria-roledescription="carousel"
          [attr.aria-labelledby]="car.otherOption.titoloSezione ? ('carousel-title-' + i) : null"
          [attr.aria-label]="!car.otherOption.titoloSezione ? 'Carosello' : null">

          <!-- PANNELLI DEL CAROSELLO -->
          <!-- [ngStyle]="{'--stagger': (idx * 80) + 'ms'}" opzionale: sblocco uno “stagger” dei pannelli con una custom property -->
          <div flicking-panel *ngFor="let item of car.data.items; trackBy: trackByIndex; let idx = index"
            [ngClass]="car.otherOption.panelClass" [ngStyle]="{'--stagger': (idx * 80) + 'ms'}">

            <!-- Media -->
            <ng-container *ngIf="hasMedia(item.media); else noMediaTpl">
              <ng-container *ngIf="getMediaFrontale(item.media) as src">
                <ng-container [ngSwitch]="item.context?.type">

                  <!-- Immagine -->
                  <img *ngSwitchCase="'image'" [src]="src" [alt]="item.context?.display_name || ''" />

                  <!-- Video -->
                  <video *ngSwitchCase="'video'" [src]="src" playsinline muted preload="auto"></video>

                  <!-- Audio -->
                  <audio *ngSwitchCase="'audio'" [src]="src" controls></audio>

                  <!-- Fallback: immagine -->
                  <img *ngSwitchDefault [src]="src" [alt]="item.context?.display_name || ''" />

                </ng-container>
              </ng-container>
            </ng-container>

            <!-- CAPTION per-pannello -->
            <div class="panel-caption" aria-hidden="true">
              <span class="panel-caption__text">
                {{ item.context?.display_name }}
              </span>
            </div>

            <!-- Placeholder media mancante -->
            <ng-template #noMediaTpl>
              <div class="media-placeholder">Nessun media disponibile</div>
            </ng-template>
          </div>

          <!-- FRECCE DI NAVIGAZIONE -->
          <span in-viewport class="flicking-arrow-prev" [class.none]="(!car.hasArrow || !setArrowSxMap[i])"
            aria-label="Slide precedente">
          </span>

          <span in-viewport class="flicking-arrow-next" [class.none]="(!car.hasArrow || setArrowDxMap[i])"
            aria-label="Slide successiva">
          </span>

          <!-- PAGINAZIONE -->
          <div in-viewport class="flicking-pagination" [class.none]="!car.hasBullet" aria-label="Paginazione carosello">
          </div>
        </ngx-flicking>
      </div> <!-- /wrapper carosello -->
    </ng-container>
    <!-- ADD GLOBALE: sempre dopo l’ultima sezione -->
    <!-- ADD GLOBALE: sempre dopo l’ultima sezione -->
    <div class="carousel-add-global" *ngIf="isAdmin">
      <button mat-icon-button (click)="apriPopUpAddCaroselloAdmin()" matTooltip="Aggiungi nuova sezione"
        [matTooltipClass]="'tooltip-custom'">
        <mat-icon>add</mat-icon>
      </button>
    </div>

  </div>
</section>