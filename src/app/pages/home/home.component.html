<!-- =============================================================================
     HOME TEMPLATE UNICO (desktop + mobile) — VERSIONE DINAMICA CON NGX-FLICKING

     Obiettivi:
     1) Il titolo (h2) della sezione è posizionato SOPRA il carosello (introduzione).
     2) Il "panel name" (display_name del media) è mostrato al CENTRO di OGNI pannello,
        come caption interna al singolo flicking-panel.

     Note architetturali:
     - Iterazione su `carousels` (factory): ogni voce configura un carosello/sezione.
     - Ogni carosello espone: car.options, car.plugins, car.data.items, car.otherOption.
     - Eventi: (ready) e (changed) gestiscono frecce e animazioni via TS.
     - Visibilità frecce/pallini: controllata da car.hasArrow / car.hasBullet e dalle mappe
       setArrowSxMap[i] (true = prev visibile) / setArrowDxMap[i] (true = next nascosta).

     Requisiti lato TS già previsti:
       trackByIndex(index: number, _: any): number
       hasMedia(media: MediaMeta[]): boolean
       getMediaFrontale(media: MediaMeta[]): string | null
       onReadyCarosello(event: any, car: ImieiCaroselli, i: number): void
       onChangedCarosello(event: any, car: ImieiCaroselli, i: number): void
       apriPopUpEditorAdmin(key: string): void
       setArrowSxMap: Record<number, boolean>  // true = freccia sinistra visibile
       setArrowDxMap: Record<number, boolean>  // true = freccia destra nascosta

     Accessibilità:
       - <ngx-flicking> usa aria-roledescription="carousel".
       - Se è presente il titolo di sezione, il carosello lo referenzia via aria-labelledby.
       - Le caption per-pannello sono aria-hidden="true" (decorative) e non intercettano tocchi.
       - Le frecce restano sopra alle caption (z-index superiore) e sono interattive.
   ============================================================================ -->

<section class="home" aria-label="Sezione principale Home">
  <div class="home-container">

    <!-- Iterazione dinamica su tutti i caroselli configurati -->
    <ng-container *ngFor="let car of carousels; let i = index; trackBy: trackByIndex">

      <!-- Header sezione esterno al carosello: contiene solo il pulsante admin -->
      <div class="carousel-section-header" *ngIf="isAdmin">
        <button
          mat-icon-button
          class="edit-admin-icon"
          (click)="apriPopUpEditorAdmin(car.otherOption.editKey)"
          [matTooltip]="car.otherOption.tooltip"
          [matTooltipClass]="'tooltip-custom'">
          <mat-icon>edit</mat-icon>
        </button>
      </div>

      <!-- TITOLO SEZIONE sopra il carosello (introduzione, non overlay) -->
      <div class="carousel-intro" *ngIf="car.otherOption.titoloSezione">
        <!-- id univoco per l’associazione ARIA -->
        <h2 class="carousel-intro__title" [attr.id]="'carousel-title-' + i">
          {{ car.otherOption.titoloSezione }}
        </h2>
      </div>

      <!-- WRAPPER CAROSELLO:
           - Contiene SOLO il carosello e i controlli interni (frecce/paginazione).
           - Deve essere position: relative (gestito via SCSS sulle classi wrapper). -->
      <div class="carousel-wrapper" [ngClass]="car.otherOption.wrapperClass">

        <!-- NGX-FLICKING:
             - Include i pannelli e l’UI interna (frecce/paginazione).
             - L’introduzione (titolo sezione) è esterna a <ngx-flicking>. -->
        <ngx-flicking
          #flickingTags
          [options]="car.options"
          [plugins]="car.plugins"
          (ready)="onReadyCarosello($event, car, i)"
          (changed)="onChangedCarosello($event, car, i)"
          aria-roledescription="carousel"
          [attr.aria-labelledby]="car.otherOption.titoloSezione ? ('carousel-title-' + i) : null"
          [attr.aria-label]="!car.otherOption.titoloSezione ? 'Carosello' : null">

          <!-- PANNELLI DEL CAROSELLO -->
          <div
            flicking-panel
            *ngFor="let item of car.data.items; trackBy: trackByIndex"
            [ngClass]="['carosello-panel', car.otherOption.panelClass]">

            <!-- Render media solo se presenti; in caso contrario mostra placeholder -->
            <ng-container *ngIf="hasMedia(item.media); else noMediaTpl">
              <ng-container *ngIf="getMediaFrontale(item.media) as src">
                <ng-container [ngSwitch]="item.context?.type">

                  <!-- Immagine -->
                  <img *ngSwitchCase="'image'"
                       [src]="src"
                       [alt]="item.context?.display_name || ''" />

                  <!-- Video -->
                  <video *ngSwitchCase="'video'"
                         [src]="src"
                         playsinline
                         muted
                         preload="auto"></video>

                  <!-- Audio -->
                  <audio *ngSwitchCase="'audio'"
                         [src]="src"
                         controls></audio>

                  <!-- Fallback: immagine -->
                  <img *ngSwitchDefault
                       [src]="src"
                       [alt]="item.context?.display_name || ''" />

                </ng-container>
              </ng-container>
            </ng-container>

            <!-- CAPTION PER-PANNELLO (panel name centrato nel pannello)
                 - Vive DENTRO il pannello per seguirne il lifecycle.
                 - Non intercetta input (pointer-events:none).
                 - Usa item.context?.display_name direttamente dal dato. -->
            <div class="panel-caption" aria-hidden="true">
              <span class="panel-caption__text">
                {{ item.context?.display_name }}
              </span>
            </div>

            <!-- Placeholder se non ci sono media -->
            <ng-template #noMediaTpl>
              <div class="media-placeholder">Nessun media disponibile</div>
            </ng-template>
          </div>

          <!-- FRECCE DI NAVIGAZIONE
               - Non usare *ngIf per non rimuovere i nodi; nascondere via classe .none.
               - La visibilità è controllata dalle mappe per indice di carosello. -->
          <span
            in-viewport
            class="flicking-arrow-prev"
            [class.none]="(!car.hasArrow || !setArrowSxMap[i])"
            aria-label="Slide precedente">
          </span>

          <span
            in-viewport
            class="flicking-arrow-next"
            [class.none]="(!car.hasArrow || setArrowDxMap[i])"
            aria-label="Slide successiva">
          </span>

          <!-- PAGINAZIONE (bullet) -->
          <div
            in-viewport
            class="flicking-pagination"
            [class.none]="!car.hasBullet"
            aria-label="Paginazione carosello">
          </div>
        </ngx-flicking>
      </div> <!-- /carousel-wrapper -->
    </ng-container>
  </div>
</section>
