<!-- ============================================================
     BLOCCO MOBILE – viene mostrato solo su schermi ≤ 768 px
     ============================================================ -->
<div *ngIf="isMobile" class="mobile-blocked">
  <h2>Accesso CMS non disponibile su mobile</h2>
  <p>Per motivi di sicurezza e usabilità, accedi da un dispositivo desktop.</p>
</div>

<!-- ============================================================
     LAYOUT DESKTOP – due colonne (sidebar + contenuto)
     ============================================================ -->
<div *ngIf="!isMobile" class="cms-layout">

  <!-- Bottone per creare una cartella RADICE -->
  <button mat-icon-button class="create-folder-button" aria-label="Crea nuova cartella principale"
    (click)="apriPopUpAddFolder('')">
    <mat-icon color="primary">create_new_folder</mat-icon>
  </button>

  <!-- ---------------  SIDEBAR (albero cartelle) --------------- -->
  <div class="cms-sidebar">
    <h1>Categorie e SottoCategorie</h1>

    <!-- spinner durante il fetch -->
    <div *ngIf="loading" class="spinner-container">
      <mat-spinner diameter="30"></mat-spinner>
      <p>Caricamento cartelle...</p>
    </div>

    <!-- mat-tree -->
    <mat-tree *ngIf="!loading" [dataSource]="dataSource" [treeControl]="treeControl" class="folder-tree">

      <!-- ===== NODO CON FIGLI ===== -->
      <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
        <div class="mat-tree-node">
          <button mat-icon-button matTreeNodeToggle>
            <mat-icon>{{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}</mat-icon>
          </button>
          <mat-icon class="mr-2">folder</mat-icon>

          <!-- titolo e azioni -->
          <div class="node-content">
            <span (click)="onNodeClick(node)" [class.selected-node]="nodoSelezionato === node">
              {{ node.name }}
            </span>

            <button mat-icon-button class="create-folder-button" (click)="apriPopUpAddFolder(node)">
              <mat-icon color="primary">create_new_folder</mat-icon>
            </button>

            <button mat-icon-button class="rename-folder-button" (click)="apriPopUpRenameFolder(node)">
              <mat-icon color="primary">edit</mat-icon>
            </button>

            <button mat-icon-button class="delete-folder-button"
              (click)="deleteFolder(node.fullPath); $event.stopPropagation();">
              <mat-icon color="warn">delete</mat-icon>
            </button>
          </div>
        </div>

        <div *ngIf="treeControl.isExpanded(node)">
          <ng-container matTreeNodeOutlet></ng-container>
        </div>
      </mat-nested-tree-node>

      <!-- ===== NODO FOGLIA ===== -->
      <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
        <div class="mat-tree-node">
          <button mat-icon-button disabled>
            <mat-icon class="transparent">chevron_right</mat-icon>
          </button>
          <mat-icon class="mr-2">insert_drive_file</mat-icon>
          <span (click)="onNodeClick(node)" [class.selected-node]="nodoSelezionato === node">
            {{ node.name }}
          </span>
        </div>
      </mat-tree-node>
    </mat-tree>

    <!-- TREE DELLE CONFIG-->
    <h1>Configurazioni</h1>

    <mat-tree *ngIf="!loading" [dataSource]="dataSourceConfig" [treeControl]="treeControl" class="folder-tree">

      <!-- ===== NODO CON FIGLI ===== -->
      <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
        <div class="mat-tree-node">
          <button mat-icon-button matTreeNodeToggle>
            <mat-icon>{{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}</mat-icon>
          </button>
          <mat-icon class="mr-2">folder</mat-icon>

          <!-- titolo e azioni -->
          <div class="node-content">
            <span (click)="onNodeClick(node)" [class.selected-node]="nodoSelezionato === node">
              {{ node.name }}
            </span>

            <!-- quando e true vuol dire che sto creando una cartella di configurazione . . .-->
            <button mat-icon-button class="create-folder-button" (click)="apriPopUpAddFolder(node,true)">
              <mat-icon color="primary">create_new_folder</mat-icon>
            </button>

            <button mat-icon-button class="rename-folder-button" (click)="apriPopUpRenameFolder(node,true)">
              <mat-icon color="primary">edit</mat-icon>
            </button>

            <button mat-icon-button class="delete-folder-button"
              (click)="deleteFolder(node.fullPath,true); $event.stopPropagation();">
              <mat-icon color="warn">delete</mat-icon>
            </button>
          </div>
        </div>

        <div *ngIf="treeControl.isExpanded(node)">
          <ng-container matTreeNodeOutlet></ng-container>
        </div>
      </mat-nested-tree-node>

      <!-- ===== NODO FOGLIA ===== -->
      <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
        <div class="mat-tree-node">
          <button mat-icon-button disabled>
            <mat-icon class="transparent">chevron_right</mat-icon>
          </button>
          <mat-icon class="mr-2">insert_drive_file</mat-icon>
          <span (click)="onNodeClick(node)" [class.selected-node]="nodoSelezionato === node">
            {{ node.name }}
          </span>
        </div>
      </mat-tree-node>
    </mat-tree>

    <button mat-raised-button class="refresh-button" (click)="goToCaricaContenuti('/cms/upload')">
      Vai a Carica Contenuti
    </button>
  </div><!-- /cms-sidebar -->

  <!-- ---------------  CONTENUTO (media) --------------- -->
  <div class="cms-content" *ngIf="nodoSelezionato?.fullPath as percorsoSelezionato">
    <!-- ---------------  CONTENUTO (media) --------------- -->
    <div class="cms-content" *ngIf="nodoSelezionato?.fullPath as percorsoSelezionato">

      <!-- Tutorial visibile solo nella cartella Config/Home/Video -->
      <div class="tutorial-box" *ngIf="percorsoSelezionato === 'Config/Home/Video'">
        <h3>📹 Guida al caricamento dei video per la Homepage</h3>
        <p>
          Carica <a [routerLink]="['/cms/upload']">qui</a> i video destinati alla homepage del sito.
        </p>
        <ul>
          <li>
            Ogni video deve avere come <strong>nome</strong> lo stesso della sottocategoria associata.
          </li>
          <li>
            Esempio: se la sottocategoria è <code>Naturale</code>, il video deve chiamarsi <code>Naturale</code>.
          </li>
          <li>
            I video verranno mostrati nella sezione "Modelli in evidenza".
          </li>
        </ul>
      </div>

      <div class="immagini-grid" *ngIf="immaginiRecuperateDaMostrare[percorsoSelezionato]?.length">
        <!-- resto del tuo codice... -->


          <!-- Ciclo sui diversi “display_name” -->
          <ng-container *ngFor="let img of immaginiRecuperateDaMostrare[percorsoSelezionato]">

            <!-- Mostro solo se c’è almeno un media valido -->
            <div class="immagine-box" *ngIf="haImmaginiFrontali(img)">

              <!-- Ciclo sui meta (angolazioni o singoli video/audio) -->
              <ng-container *ngFor="let angolo of img.meta">

                <!-- Wrapper di UN media -->
                <div class="immagine-wrapper" *ngIf="getTipo(angolo.url) as tipoMedia"
                  [class.hide]="tipoMedia==='image' && angolo.angolazione!=='frontale'">

                  <!-- X: elimina l’intero display_name -->
                  <button mat-icon-button class="delete-button" (click)="eliminaImmagini(img)">
                    <mat-icon>close</mat-icon>
                  </button>

                  <button mat-icon-button class="download-button" (click)="downloadMedia(angolo.url, img.display_name)">
                    <mat-icon>download</mat-icon>
                  </button>
                  <!-- Media -->
                  <ng-container [ngSwitch]="tipoMedia">
                    <!-- Immagine -->
                    <img *ngSwitchCase="'image'" class="immagine-principale" [src]="angolo.url" [alt]="img.display_name"
                      (click)="apriPopUpGalleriaFotoNoFrontali(img.meta,img.display_name)" />



                    <!-- Video -->
                    <video *ngSwitchCase="'video'" class="immagine-principale" [src]="angolo.url" controls></video>

                    <!-- Audio -->
                    <audio *ngSwitchCase="'audio'" class="audio-player" [src]="angolo.url" controls></audio>
                  </ng-container>

                  <!-- Quantità (solo immagini) -->
                  <small *ngIf="tipoMedia==='image'">Quantità: {{ img.quantita }}</small>

                  <!-- Dettagli + (eventuale) form modifica -->
                  <div class="dettagli">
                    <strong>{{ img.display_name }}</strong>
                    <p *ngIf="tipoMedia==='image'">{{ img.descrizione }}</p>

                    <!-- modifico immagine audio o video-->
                    <button mat-button
                      *ngIf="immagineInModifica!==img && (tipoMedia==='image' || tipoMedia==='video' || tipoMedia==='audio')"
                      (click)="apriFormModifica(img)">
                      Modifica
                    </button>

                    <!-- Form di modifica -->
                    <form
                      *ngIf="immagineInModifica===img && (tipoMedia==='image' || tipoMedia==='video' || tipoMedia==='audio')"
                      #modificaForm="ngForm" (ngSubmit)="onSubmitModifica(img)">
                      <mat-form-field *ngIf="tipoMedia==='image'" appearance="fill" class="full-width">
                        <mat-label>Descrizione</mat-label>
                        <input matInput name="descrizione" [(ngModel)]="valoriModifica.descrizione" />
                      </mat-form-field>

                      <mat-form-field *ngIf="tipoMedia==='image'" appearance="fill" class="full-width">
                        <mat-label>Quantità</mat-label>
                        <input matInput type="number" min="0" name="quantita" [(ngModel)]="valoriModifica.quantita" />
                      </mat-form-field>

                      <mat-form-field appearance="fill" class="full-width">
                        <mat-label>Nome</mat-label>
                        <input matInput name="nome" [(ngModel)]="valoriModifica.nome_file" />
                      </mat-form-field>

                      <div class="form-actions">
                        <button mat-stroked-button color="primary" type="submit">Salva</button>
                        <button mat-button type="button" (click)="immagineInModifica = null">Annulla</button>
                      </div>
                    </form>
                  </div><!-- /dettagli -->
                </div><!-- /immagine-wrapper -->
              </ng-container>
            </div><!-- /immagine-box -->
          </ng-container>
        </div><!-- /immagini-grid -->
      </div><!-- /cms-content -->

    </div><!-- /cms-layout -->