<!-- ============================================================
     BLOCCO MOBILE  – se l’utente apre da uno schermo ≤ 768 px
     ============================================================ -->
<div *ngIf="isMobile" class="mobile-blocked">
  <h2>Accesso CMS non disponibile su mobile</h2>
  <p>Per motivi di sicurezza e usabilità, accedi da un dispositivo desktop.</p>
</div>

<!-- ============================================================
     LAYOUT DESKTOP  – mostrato solo se isMobile è false
     Due colonne:  sidebar (sinistra)  +  contenuto (destra)
     ============================================================ -->
<div *ngIf="!isMobile" class="cms-layout">

  <!-- ◀ Bottone per creare una cartella principale (radice) -->
  <button  mat-icon-button
           class="create-folder-button"
           aria-label="Crea nuova cartella principale"
           (click)="apriPopUpAddFolder('')">
    <mat-icon color="primary">create_new_folder</mat-icon>
  </button>

  <!-- ========================================================
       SIDEBAR SINISTRA – albero cartelle (Angular Material Tree)
       ======================================================== -->
  <div class="cms-sidebar">

    <!-- Spinner mentre si caricano le cartelle -->
    <div *ngIf="loading" class="spinner-container">
      <mat-spinner diameter="30"></mat-spinner>
      <p>Caricamento cartelle...</p>
    </div>

    <!-- Albero cartelle (ngx-material tree) -->
    <mat-tree *ngIf="!loading"
              [dataSource]="dataSource"
              [treeControl]="treeControl"
              class="folder-tree">

      <!-- ======= NODO CON FIGLI ======= -->
      <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild"
                            matTreeNodePadding>

        <div class="mat-tree-node">
          <!-- icona di espansione/contrazione -->
          <button mat-icon-button matTreeNodeToggle>
            <mat-icon>
              {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
            </mat-icon>
          </button>

          <!-- icona cartella -->
          <mat-icon class="mr-2">folder</mat-icon>

          <!-- Titolo cartella e azioni -->
          <div class="node-content">
            <!-- click = seleziona cartella -->
            <span  (click)="onNodeClick(node)"
                   [class.selected-node]="nodoSelezionato === node">
              {{ node.name }}
            </span>

            <!-- azione: crea sottocartella -->
            <button mat-icon-button class="create-folder-button"
                    (click)="apriPopUpAddFolder(node)">
              <mat-icon color="primary">create_new_folder</mat-icon>
            </button>

            <!-- azione: rinomina cartella -->
            <button mat-icon-button class="rename-folder-button"
                    (click)="apriPopUpRenameFolder(node)">
              <mat-icon color="primary">edit</mat-icon>
            </button>

            <!-- azione: elimina cartella -->
            <button mat-icon-button class="delete-folder-button"
                    (click)="deleteFolder(node.fullPath); $event.stopPropagation();">
              <mat-icon color="warn">delete</mat-icon>
            </button>
          </div> <!-- /node-content -->
        </div>

        <!-- outlet ricorsivo per i figli -->
        <div *ngIf="treeControl.isExpanded(node)">
          <ng-container matTreeNodeOutlet></ng-container>
        </div>
      </mat-nested-tree-node>

      <!-- ======= NODO FOGLIA (senza figli) ======= -->
      <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
        <div class="mat-tree-node">
          <!-- icona “fantasma” per allineare -->
          <button mat-icon-button disabled>
            <mat-icon class="transparent">chevron_right</mat-icon>
          </button>
          <mat-icon class="mr-2">insert_drive_file</mat-icon>

          <!-- click = seleziona cartella foglia -->
          <span (click)="onNodeClick(node)"
                [class.selected-node]="nodoSelezionato === node">
            {{ node.name }}
          </span>
        </div>
      </mat-tree-node>
    </mat-tree>

    <!-- Pulsante per passare alla pagina di upload contenuti -->
    <button mat-raised-button class="refresh-button"
            (click)="goToCaricaContenuti('/cms/upload')">
      Vai a Carica Contenuti
    </button>
  </div> <!-- /cms-sidebar -->

  <!-- ========================================================
       COLONNA DESTRA – area contenuti (immagini / video / audio)
       ======================================================== -->
  <div class="cms-content"
       *ngIf="nodoSelezionato?.fullPath as percorsoSelezionato">

    <!-- Griglia dei media: mostrata solo se esistono elementi -->
    <div class="immagini-grid"
         *ngIf="immaginiRecuperateDaMostrare[percorsoSelezionato]?.length">

      <!-- Ciclo sugli oggetti “img” (un display_name) -->
      <ng-container *ngFor="let img of immaginiRecuperateDaMostrare[percorsoSelezionato]">

        <!-- Mostra il riquadro solo se passa il filtro frontale/video/audio -->
        <div class="immagine-box"
             *ngIf="haImmaginiFrontali(img)">

          <!-- Ciclo sui meta (angolazioni o singoli video/audio) -->
          <ng-container *ngFor="let angolo of img.meta">

            <!-- Wrapper del singolo media -->
            <div class="immagine-wrapper"
                 *ngIf="getTipo(angolo.url) as tipoMedia"
                 [class.hide]="tipoMedia === 'image' && angolo.angolazione !== 'frontale'">

              <!-- =============== BLOCCO MEDIA =============== -->
              <!-- Pulsante elimina (vale per tutto il display_name) -->
              <button mat-icon-button class="delete-button"
                      (click)="eliminaImmagini(img)">
                <mat-icon color="warn">close</mat-icon>
              </button>

              <!-- Media a seconda del tipo -->
              <ng-container [ngSwitch]="tipoMedia">

                <!-- IMMAGINE (solo frontale viene mostrata) -->
                <img   *ngSwitchCase="'image'"
                       class="immagine-principale"
                       [src]="angolo.url"
                       [alt]="img.display_name"
                       (click)="apriPopUpGalleriaFotoNoFrontali(img.meta)" />

                <!-- VIDEO -->
                <video *ngSwitchCase="'video'"
                       class="immagine-principale"
                       [src]="angolo.url"
                       controls></video>

                <!-- AUDIO -->
                <audio *ngSwitchCase="'audio'"
                       class="audio-player"
                       [src]="angolo.url"
                       controls></audio>
              </ng-container>

              <!-- Quantità (visibile solo per immagini) -->
              <small *ngIf="tipoMedia === 'image'">
                Quantità: {{ img.quantita }}
              </small>
              <!-- ============ / BLOCCO MEDIA ============= -->

              <!-- ============ DETTAGLI + FORM MODIFICA =========== -->
              <div class="dettagli">
                <strong>{{ img.display_name }}</strong>
                <p *ngIf="tipoMedia === 'image'">{{ img.descrizione }}</p>

                <!-- Pulsante “Modifica” – solo per immagini -->
                <button mat-button
                        *ngIf="immagineInModifica !== img && tipoMedia === 'image'"
                        (click)="apriFormModifica(img)">
                  Modifica
                </button>

                <!-- Form di modifica (visibile solo sull’immagine da editare) -->
                <form  *ngIf="immagineInModifica === img && tipoMedia === 'image'"
                       #modificaForm="ngForm"
                       (ngSubmit)="onSubmitModifica(img)">

                  <!-- Descrizione -->
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Descrizione</mat-label>
                    <input matInput name="descrizione"
                           [(ngModel)]="valoriModifica.descrizione" />
                  </mat-form-field>

                  <!-- Quantità -->
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Quantità</mat-label>
                    <input matInput type="number" min="0" name="quantita"
                           [(ngModel)]="valoriModifica.quantita" />
                  </mat-form-field>

                  <!-- Nome file -->
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Nome</mat-label>
                    <input matInput name="nome"
                           [(ngModel)]="valoriModifica.nome_file" />
                  </mat-form-field>

                  <!-- Pulsanti form -->
                  <div class="form-actions">
                    <button mat-stroked-button type="submit" color="primary">
                      Salva
                    </button>
                    <button mat-button type="button"
                            (click)="immagineInModifica = null">
                      Annulla
                    </button>
                  </div>
                </form>
              </div>
              <!-- ========== / DETTAGLI ========== -->
            </div> <!-- /immagine-wrapper -->

          </ng-container>
        </div> <!-- /immagine-box -->
      </ng-container>
    </div> <!-- /immagini-grid -->
  </div> <!-- /cms-content -->
</div> <!-- /cms-layout -->
